<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SC HOTAS Tool — Test &amp; Bind</title>
<style>
  :root {
    --bg: #0a0e17;
    --surface: #111827;
    --border: #1e293b;
    --text: #e2e8f0;
    --dim: #64748b;
    --accent: #38bdf8;
    --accent2: #f97316;
    --active: #22d3ee;
    --danger: #ef4444;
    --success: #22c55e;
    --glow: rgba(56, 189, 248, 0.3);
    --warning: #eab308;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    min-height: 100vh; overflow-x: hidden;
  }

  /* ---- Header ---- */
  header {
    text-align: center; padding: 1.2rem 1rem 0.8rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(56,189,248,0.05) 0%, transparent 100%);
  }
  header h1 { font-size: 1.4rem; font-weight: 600; letter-spacing: 0.05em; color: var(--accent); }
  header p  { font-size: 0.8rem; color: var(--dim); margin-top: 0.2rem; }

  /* ---- Mode tabs ---- */
  .mode-tabs {
    display: flex; justify-content: center; gap: 0;
    background: var(--surface); border-bottom: 1px solid var(--border);
  }
  .mode-tab {
    padding: 0.7rem 2rem; font-size: 0.85rem; font-weight: 500;
    cursor: pointer; border: none; background: none; color: var(--dim);
    border-bottom: 2px solid transparent; transition: all 0.2s;
  }
  .mode-tab:hover { color: var(--text); }
  .mode-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* ---- Connection bar ---- */
  #connection-status {
    display: flex; justify-content: center; gap: 1.5rem;
    padding: 0.6rem; background: var(--surface);
    border-bottom: 1px solid var(--border); flex-wrap: wrap;
  }
  .device-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger); transition: background 0.3s;
  }
  .status-dot.connected { background: var(--success); box-shadow: 0 0 6px rgba(34,197,94,0.5); }

  /* ---- Shared panels ---- */
  .device-panel {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden;
  }
  .device-panel h2 {
    font-size: 0.95rem; padding: 0.75rem 1rem;
    background: linear-gradient(90deg, rgba(56,189,248,0.1), transparent);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 0.5rem;
  }
  .device-panel h2 .tag {
    font-size: 0.65rem; background: var(--accent); color: var(--bg);
    padding: 0.1rem 0.4rem; border-radius: 3px; font-weight: 700;
  }
  .device-content { padding: 1rem; }
  .device-select {
    padding: 0.6rem 1rem; background: rgba(249,115,22,0.05);
    border-bottom: 1px solid var(--border); font-size: 0.8rem;
  }
  .device-select label { color: var(--dim); margin-right: 0.5rem; }
  .device-select select {
    background: var(--bg); color: var(--text);
    border: 1px solid var(--border); border-radius: 4px;
    padding: 0.25rem 0.5rem; font-size: 0.75rem;
  }

  .no-gamepad-msg {
    text-align: center; padding: 3rem 1rem; color: var(--dim);
    font-size: 0.95rem; line-height: 1.8;
  }
  .no-gamepad-msg strong { color: var(--accent); font-weight: 600; }

  /* ---- Test mode (original) ---- */
  .main-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;
    padding: 1rem; max-width: 1400px; margin: 0 auto;
  }
  @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

  .axes-section h3, .buttons-section h3 {
    font-size: 0.75rem; text-transform: uppercase;
    letter-spacing: 0.1em; color: var(--dim); margin-bottom: 0.75rem;
  }
  .axis-row {
    display: flex; align-items: center; gap: 0.75rem;
    margin-bottom: 0.6rem; font-size: 0.8rem;
  }
  .axis-label { width: 90px; text-align: right; color: var(--dim); font-size: 0.75rem; flex-shrink: 0; }
  .axis-bar-container {
    flex: 1; height: 20px; background: rgba(30,41,59,0.8);
    border-radius: 4px; position: relative; overflow: hidden;
    border: 1px solid var(--border);
  }
  .axis-bar-center { position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: var(--dim); opacity: 0.4; }
  .axis-bar-fill {
    position: absolute; top: 2px; bottom: 2px; background: var(--accent);
    border-radius: 2px; transition: left 0.03s, width 0.03s, background 0.1s;
    box-shadow: 0 0 8px var(--glow);
  }
  .axis-bar-fill.negative { background: var(--accent2); box-shadow: 0 0 8px rgba(249,115,22,0.3); }
  .axis-bar-fill.throttle { left: 0 !important; background: linear-gradient(90deg, var(--success), var(--accent)); }
  .axis-deadzone {
    position: absolute; top: 0; bottom: 0;
    background: rgba(239,68,68,0.1);
    border-left: 1px dashed rgba(239,68,68,0.3);
    border-right: 1px dashed rgba(239,68,68,0.3);
  }
  .axis-value { width: 50px; text-align: right; font-family: 'Courier New', monospace; font-size: 0.7rem; color: var(--dim); flex-shrink: 0; }
  .axis-action { width: 160px; font-size: 0.7rem; color: var(--active); flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .axis-action.active { color: var(--accent2); font-weight: 600; }

  .buttons-section { margin-top: 1.25rem; }
  .buttons-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.4rem; }
  .btn-item {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.4rem 0.6rem; border-radius: 6px;
    background: rgba(30,41,59,0.4); border: 1px solid transparent;
    transition: all 0.1s; font-size: 0.75rem;
  }
  .btn-item.active { background: rgba(56,189,248,0.15); border-color: var(--accent); box-shadow: 0 0 12px var(--glow); }
  .btn-indicator {
    width: 24px; height: 24px; border-radius: 50%;
    background: rgba(30,41,59,0.8); border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.6rem; font-weight: 700; color: var(--dim);
    flex-shrink: 0; transition: all 0.1s;
  }
  .btn-item.active .btn-indicator { background: var(--accent); border-color: var(--accent); color: var(--bg); box-shadow: 0 0 10px var(--glow); }
  .btn-action { color: var(--dim); transition: color 0.1s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .btn-item.active .btn-action { color: var(--text); font-weight: 500; }

  .hat-section { margin-top: 1.25rem; }
  .hat-container { display: flex; align-items: center; gap: 2rem; flex-wrap: wrap; }
  .hat-visual { width: 120px; height: 120px; position: relative; flex-shrink: 0; }
  .hat-center {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    width: 30px; height: 30px; border-radius: 50%;
    background: var(--border); border: 2px solid var(--dim);
  }
  .hat-dir {
    position: absolute; width: 36px; height: 36px; border-radius: 6px;
    background: rgba(30,41,59,0.8); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.6rem; color: var(--dim); transition: all 0.1s;
  }
  .hat-dir.active { background: var(--accent); border-color: var(--accent); color: var(--bg); font-weight: 700; box-shadow: 0 0 12px var(--glow); }
  .hat-dir.up { top: 4px; left: 50%; transform: translateX(-50%); }
  .hat-dir.down { bottom: 4px; left: 50%; transform: translateX(-50%); }
  .hat-dir.left { left: 4px; top: 50%; transform: translateY(-50%); }
  .hat-dir.right { right: 4px; top: 50%; transform: translateY(-50%); }
  .hat-labels { font-size: 0.75rem; line-height: 1.8; }
  .hat-labels .hat-label-row { display: flex; align-items: center; gap: 0.5rem; }
  .hat-labels .dir-tag { display: inline-block; width: 16px; font-size: 0.65rem; color: var(--dim); text-align: center; }
  .hat-labels .action-name { color: var(--active); }
  .hat-labels .hat-label-row.active .action-name { color: var(--accent2); font-weight: 600; }

  .action-log h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--dim); margin-bottom: 0.5rem; }
  .log-entries { max-height: 120px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.7rem; line-height: 1.6; }
  .log-entries::-webkit-scrollbar { width: 4px; }
  .log-entries::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .log-entry { color: var(--dim); padding: 0.1rem 0; }
  .log-entry .log-input { color: var(--accent); }
  .log-entry .log-action { color: var(--accent2); }
  .log-entry .log-time { color: var(--border); }

  .crosshair-section { display: flex; gap: 1.5rem; align-items: flex-start; flex-wrap: wrap; margin-bottom: 1rem; }
  .crosshair-container {
    position: relative; width: 160px; height: 160px;
    background: rgba(30,41,59,0.5); border: 1px solid var(--border);
    border-radius: 8px; flex-shrink: 0;
  }
  .crosshair-label { position: absolute; top: -18px; left: 0; font-size: 0.65rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.05em; }
  .crosshair-hline, .crosshair-vline { position: absolute; background: var(--border); opacity: 0.3; }
  .crosshair-hline { left: 0; right: 0; top: 50%; height: 1px; }
  .crosshair-vline { top: 0; bottom: 0; left: 50%; width: 1px; }
  .crosshair-dot {
    position: absolute; width: 12px; height: 12px; border-radius: 50%;
    background: var(--accent); border: 2px solid white;
    box-shadow: 0 0 10px var(--glow); transform: translate(-50%,-50%);
    transition: left 0.03s, top 0.03s; left: 50%; top: 50%;
  }
  .crosshair-axis-labels { position: absolute; font-size: 0.55rem; color: var(--dim); }
  .crosshair-axis-labels.top { top: 2px; left: 50%; transform: translateX(-50%); }
  .crosshair-axis-labels.bottom { bottom: 2px; left: 50%; transform: translateX(-50%); }
  .crosshair-axis-labels.left-label { left: 4px; top: 50%; transform: translateY(-50%); }
  .crosshair-axis-labels.right-label { right: 4px; top: 50%; transform: translateY(-50%); }

  footer { text-align: center; padding: 1rem; font-size: 0.7rem; color: var(--border); border-top: 1px solid var(--border); margin-top: 1rem; }

  /* ===========================================================
     BIND MODE
     =========================================================== */
  .bind-container {
    max-width: 1400px; margin: 0 auto; padding: 1rem;
    display: grid; grid-template-columns: 1fr 340px; gap: 1rem;
  }
  @media (max-width: 1000px) { .bind-container { grid-template-columns: 1fr; } }

  /* Toolbar */
  .bind-toolbar {
    display: flex; gap: 0.5rem; padding: 0.75rem 1rem;
    background: var(--surface); border-bottom: 1px solid var(--border);
    flex-wrap: wrap; align-items: center; justify-content: center;
  }
  .bind-toolbar button, .bind-toolbar label {
    font-size: 0.78rem; padding: 0.4rem 0.9rem; border-radius: 6px;
    border: 1px solid var(--border); background: var(--bg); color: var(--text);
    cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 0.4rem;
  }
  .bind-toolbar button:hover { border-color: var(--accent); color: var(--accent); }
  .bind-toolbar button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 600; }
  .bind-toolbar button.primary:hover { background: #2da8e0; }
  .bind-toolbar button.danger { border-color: var(--danger); color: var(--danger); }
  .bind-toolbar button.danger:hover { background: rgba(239,68,68,0.15); }
  .bind-toolbar .separator { width: 1px; height: 24px; background: var(--border); margin: 0 0.25rem; }
  .bind-toolbar input[type="file"] { display: none; }
  .bind-toolbar .profile-name {
    background: var(--bg); color: var(--text); border: 1px solid var(--border);
    border-radius: 4px; padding: 0.35rem 0.6rem; font-size: 0.78rem; width: 200px;
  }
  .bind-toolbar .profile-name:focus { border-color: var(--accent); outline: none; }
  .bind-toolbar .toolbar-label { font-size: 0.7rem; color: var(--dim); padding: 0; border: none; background: none; cursor: default; }

  /* Category accordion */
  .bind-categories { display: flex; flex-direction: column; gap: 0.5rem; }
  .bind-category {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; overflow: hidden;
  }
  .bind-cat-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0.6rem 1rem; cursor: pointer; user-select: none;
    background: linear-gradient(90deg, rgba(56,189,248,0.06), transparent);
    border-bottom: 1px solid transparent; transition: all 0.15s;
  }
  .bind-cat-header:hover { background: rgba(56,189,248,0.1); }
  .bind-cat-header.open { border-bottom-color: var(--border); }
  .bind-cat-header .cat-name { font-size: 0.82rem; font-weight: 600; }
  .bind-cat-header .cat-count {
    font-size: 0.65rem; color: var(--dim);
    background: rgba(30,41,59,0.8); padding: 0.15rem 0.5rem; border-radius: 10px;
  }
  .bind-cat-header .cat-arrow {
    font-size: 0.7rem; color: var(--dim); transition: transform 0.2s;
  }
  .bind-cat-header.open .cat-arrow { transform: rotate(90deg); }
  .bind-cat-body { display: none; }
  .bind-cat-body.open { display: block; }

  /* Action row */
  .bind-action-row {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.45rem 1rem; border-bottom: 1px solid rgba(30,41,59,0.5);
    font-size: 0.78rem; transition: background 0.1s;
  }
  .bind-action-row:last-child { border-bottom: none; }
  .bind-action-row:hover { background: rgba(56,189,248,0.04); }
  .bind-action-row.listening {
    background: rgba(249,115,22,0.1); border-color: var(--accent2);
  }
  .bind-action-row.conflict { background: rgba(239,68,68,0.06); }
  .bind-action-row.conflict .binding-value { color: var(--danger); background: rgba(239,68,68,0.12); }
  .bind-action-row .action-name-col {
    flex: 1; min-width: 0;
  }
  .bind-action-row .action-label { color: var(--text); font-weight: 500; }
  .bind-action-row .action-sc-name { font-size: 0.65rem; color: var(--dim); font-family: 'Courier New', monospace; }
  .bind-action-row .binding-col {
    width: 140px; flex-shrink: 0; text-align: center;
  }
  .bind-action-row .binding-value {
    font-family: 'Courier New', monospace; font-size: 0.72rem;
    color: var(--accent); padding: 0.2rem 0.5rem;
    background: rgba(56,189,248,0.08); border-radius: 4px;
    display: inline-block; min-width: 60px;
  }
  .bind-action-row .binding-value.empty { color: var(--dim); background: none; }
  .bind-action-row .binding-value.listening-indicator {
    color: var(--accent2); background: rgba(249,115,22,0.15);
    animation: pulse 1s infinite;
  }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  .bind-action-row .action-buttons {
    display: flex; gap: 0.3rem; flex-shrink: 0;
  }
  .bind-action-row .action-buttons button {
    font-size: 0.65rem; padding: 0.25rem 0.5rem; border-radius: 4px;
    border: 1px solid var(--border); background: var(--bg); color: var(--dim);
    cursor: pointer; transition: all 0.1s;
  }
  .bind-action-row .action-buttons button:hover { color: var(--text); border-color: var(--accent); }
  .bind-action-row .action-buttons button.bind-btn { color: var(--accent); border-color: rgba(56,189,248,0.3); }
  .bind-action-row .action-buttons button.bind-btn:hover { background: rgba(56,189,248,0.1); }
  .bind-action-row .action-buttons button.clear-btn { color: var(--danger); border-color: rgba(239,68,68,0.2); }
  .bind-action-row .action-buttons button.clear-btn:hover { background: rgba(239,68,68,0.1); }
  .invert-label { font-size: 0.6rem; color: var(--dim); cursor: pointer; display: flex; align-items: center; gap: 0.2rem; }
  .invert-label input[type="checkbox"] { margin: 0; cursor: pointer; }
  .bind-action-row.listening .action-buttons button.bind-btn {
    background: var(--accent2); color: var(--bg); border-color: var(--accent2);
  }

  /* Right sidebar: live input monitor */
  .bind-sidebar { display: flex; flex-direction: column; gap: 0.75rem; }
  .live-monitor {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 1rem; position: sticky; top: 1rem;
  }
  .live-monitor h3 {
    font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--dim); margin-bottom: 0.75rem;
  }
  .live-input-display {
    font-family: 'Courier New', monospace; font-size: 1.1rem;
    color: var(--accent); text-align: center; padding: 1rem;
    background: rgba(30,41,59,0.5); border-radius: 8px;
    min-height: 50px; display: flex; align-items: center;
    justify-content: center; margin-bottom: 0.75rem;
    border: 1px solid var(--border);
  }
  .live-input-display.has-input { color: var(--accent2); border-color: var(--accent2); background: rgba(249,115,22,0.05); }
  .mini-axis-row {
    display: flex; align-items: center; gap: 0.5rem;
    margin-bottom: 0.35rem; font-size: 0.7rem;
  }
  .mini-axis-row .mini-label { width: 70px; text-align: right; color: var(--dim); flex-shrink: 0; }
  .mini-axis-row .mini-bar {
    flex: 1; height: 10px; background: rgba(30,41,59,0.8);
    border-radius: 3px; position: relative; overflow: hidden;
    border: 1px solid var(--border);
  }
  .mini-axis-row .mini-bar-fill {
    position: absolute; top: 1px; bottom: 1px; background: var(--accent);
    border-radius: 2px; transition: left 0.03s, width 0.03s;
  }
  .mini-axis-row .mini-val { width: 40px; text-align: right; font-family: 'Courier New', monospace; font-size: 0.6rem; color: var(--dim); }
  .mini-buttons-grid {
    display: flex; flex-wrap: wrap; gap: 3px; margin-top: 0.5rem;
  }
  .mini-btn {
    width: 22px; height: 22px; border-radius: 4px; font-size: 0.55rem;
    background: rgba(30,41,59,0.6); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    color: var(--dim); transition: all 0.05s;
  }
  .mini-btn.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .mini-device-label { font-size: 0.7rem; color: var(--dim); margin: 0.6rem 0 0.3rem; font-weight: 600; }

  /* Export modal */
  .modal-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); display: flex; align-items: center;
    justify-content: center; z-index: 1000; backdrop-filter: blur(4px);
  }
  .modal-overlay.hidden { display: none; }
  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh;
    overflow: auto; padding: 1.5rem;
  }
  .modal h2 { font-size: 1rem; margin-bottom: 1rem; color: var(--accent); }
  .modal pre {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 1rem; font-size: 0.7rem;
    overflow: auto; max-height: 400px; line-height: 1.5;
    color: var(--dim);
  }
  .modal .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end; }
  .modal .modal-actions button {
    padding: 0.5rem 1.2rem; border-radius: 6px; font-size: 0.8rem;
    border: 1px solid var(--border); background: var(--bg); color: var(--text);
    cursor: pointer; transition: all 0.15s;
  }
  .modal .modal-actions button.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); font-weight: 600; }
  .modal .modal-actions button:hover { opacity: 0.85; }

  /* Toast */
  .toast {
    position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
    background: var(--success); color: var(--bg); padding: 0.6rem 1.5rem;
    border-radius: 8px; font-size: 0.8rem; font-weight: 600;
    z-index: 1001; opacity: 0; transition: opacity 0.3s; pointer-events: none;
  }
  .toast.show { opacity: 1; }
</style>
</head>
<body>

<header>
  <h1>SC HOTAS Tool</h1>
  <p>Star Citizen &bull; Test your inputs &bull; Create custom binding profiles</p>
</header>

<!-- Mode Tabs -->
<div class="mode-tabs">
  <button class="mode-tab active" data-mode="test" onclick="switchMode('test')">Test Mode</button>
  <button class="mode-tab" data-mode="bind" onclick="switchMode('bind')">Bind Mode</button>
</div>

<div id="connection-status">
  <div class="device-status">
    <div class="status-dot" id="js1-status"></div>
    <span id="js1-name">JS1 (Joystick): Not connected</span>
  </div>
  <div class="device-status">
    <div class="status-dot" id="js2-status"></div>
    <span id="js2-name">JS2 (Throttle): Not connected</span>
  </div>
</div>

<div id="no-gamepad" class="no-gamepad-msg">
  <p>No gamepads detected yet.</p>
  <p><strong>Press any button</strong> on your T16000m or TWCS Throttle to connect.</p>
  <p style="margin-top:1rem; font-size:0.8rem;">
    Make sure your browser supports the Gamepad API (Firefox/Chrome).<br>
    On Linux, your devices should appear via <code>/dev/input/js*</code>.
  </p>
</div>

<!-- ===== TEST MODE (original, unchanged) ===== -->
<div id="test-mode" style="display:none;">
<div id="main-content" class="main-grid">
  <div class="device-panel">
    <h2>T.16000M Joystick <span class="tag">JS1</span></h2>
    <div class="device-select">
      <label for="js1-select">Gamepad:</label>
      <select id="js1-select"><option value="-1">Auto-detect</option></select>
    </div>
    <div class="device-content">
      <div class="crosshair-section">
        <div style="position:relative; padding-top: 20px;">
          <div class="crosshair-container">
            <span class="crosshair-label">Pitch / Roll</span>
            <div class="crosshair-hline"></div><div class="crosshair-vline"></div>
            <div class="crosshair-dot" id="js1-dot-xy"></div>
            <span class="crosshair-axis-labels top">Pitch&uarr;</span>
            <span class="crosshair-axis-labels bottom">Pitch&darr;</span>
            <span class="crosshair-axis-labels left-label">Roll&larr;</span>
            <span class="crosshair-axis-labels right-label">Roll&rarr;</span>
          </div>
        </div>
        <div style="flex:1; min-width:200px;">
          <div class="axes-section">
            <h3>Axes</h3>
            <div class="axis-row"><span class="axis-label">X (Roll)</span><div class="axis-bar-container"><div class="axis-bar-center"></div><div class="axis-deadzone" id="js1-dz-x"></div><div class="axis-bar-fill" id="js1-bar-x"></div></div><span class="axis-value" id="js1-val-x">0.00</span><span class="axis-action" id="js1-act-x">js1_x</span></div>
            <div class="axis-row"><span class="axis-label">Y (Pitch)</span><div class="axis-bar-container"><div class="axis-bar-center"></div><div class="axis-deadzone" id="js1-dz-y"></div><div class="axis-bar-fill" id="js1-bar-y"></div></div><span class="axis-value" id="js1-val-y">0.00</span><span class="axis-action" id="js1-act-y">js1_y</span></div>
            <div class="axis-row"><span class="axis-label">Rz (Yaw)</span><div class="axis-bar-container"><div class="axis-bar-center"></div><div class="axis-deadzone" id="js1-dz-z"></div><div class="axis-bar-fill" id="js1-bar-z"></div></div><span class="axis-value" id="js1-val-z">0.00</span><span class="axis-action" id="js1-act-z">js1_rotz</span></div>
          </div>
        </div>
      </div>
      <div class="hat-section">
        <h3 style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--dim); margin-bottom:0.75rem;">Hat Switch</h3>
        <div class="hat-container">
          <div class="hat-visual">
            <div class="hat-dir up" id="js1-hat-up">&blacktriangle;</div>
            <div class="hat-dir down" id="js1-hat-down">&blacktriangledown;</div>
            <div class="hat-dir left" id="js1-hat-left">&#9664;</div>
            <div class="hat-dir right" id="js1-hat-right">&#9654;</div>
            <div class="hat-center"></div>
          </div>
          <div class="hat-labels">
            <div class="hat-label-row" id="js1-hat-label-up"><span class="dir-tag">&blacktriangle;</span> <span class="action-name">hat1_up</span></div>
            <div class="hat-label-row" id="js1-hat-label-right"><span class="dir-tag">&#9654;</span> <span class="action-name">hat1_right</span></div>
            <div class="hat-label-row" id="js1-hat-label-down"><span class="dir-tag">&blacktriangledown;</span> <span class="action-name">hat1_down</span></div>
            <div class="hat-label-row" id="js1-hat-label-left"><span class="dir-tag">&#9664;</span> <span class="action-name">hat1_left</span></div>
          </div>
        </div>
      </div>
      <div class="buttons-section"><h3>Buttons</h3><div class="buttons-grid" id="js1-buttons"></div></div>
    </div>
  </div>
  <div class="device-panel">
    <h2>TWCS Throttle <span class="tag">JS2</span></h2>
    <div class="device-select">
      <label for="js2-select">Gamepad:</label>
      <select id="js2-select"><option value="-1">Auto-detect</option></select>
    </div>
    <div class="device-content">
      <div class="crosshair-section">
        <div style="position:relative; padding-top: 20px;">
          <div class="crosshair-container">
            <span class="crosshair-label">Ministick (Strafe)</span>
            <div class="crosshair-hline"></div><div class="crosshair-vline"></div>
            <div class="crosshair-dot" id="js2-dot-xy"></div>
            <span class="crosshair-axis-labels top">Up</span><span class="crosshair-axis-labels bottom">Down</span>
            <span class="crosshair-axis-labels left-label">Left</span><span class="crosshair-axis-labels right-label">Right</span>
          </div>
        </div>
        <div style="flex:1; min-width:200px;">
          <div class="axes-section">
            <h3>Axes</h3>
            <div class="axis-row"><span class="axis-label">Z (Throttle)</span><div class="axis-bar-container"><div class="axis-deadzone" id="js2-dz-z"></div><div class="axis-bar-fill throttle" id="js2-bar-z"></div></div><span class="axis-value" id="js2-val-z">0.00</span><span class="axis-action" id="js2-act-z">js2_z</span></div>
            <div class="axis-row"><span class="axis-label">X (Strafe L/R)</span><div class="axis-bar-container"><div class="axis-bar-center"></div><div class="axis-deadzone" id="js2-dz-x"></div><div class="axis-bar-fill" id="js2-bar-x"></div></div><span class="axis-value" id="js2-val-x">0.00</span><span class="axis-action" id="js2-act-x">js2_x</span></div>
            <div class="axis-row"><span class="axis-label">Y (Strafe U/D)</span><div class="axis-bar-container"><div class="axis-bar-center"></div><div class="axis-deadzone" id="js2-dz-y"></div><div class="axis-bar-fill" id="js2-bar-y"></div></div><span class="axis-value" id="js2-val-y">0.00</span><span class="axis-action" id="js2-act-y">js2_y</span></div>
            <div class="axis-row"><span class="axis-label">RX (Rocker)</span><div class="axis-bar-container"><div class="axis-bar-center"></div><div class="axis-deadzone" id="js2-dz-rx"></div><div class="axis-bar-fill" id="js2-bar-rx"></div></div><span class="axis-value" id="js2-val-rx">0.00</span><span class="axis-action" id="js2-act-rx">js2_rotx</span></div>
          </div>
        </div>
      </div>
      <div class="hat-section">
        <h3 style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--dim); margin-bottom:0.75rem;">Hat Switch &mdash; Shield Mgmt</h3>
        <div class="hat-container">
          <div class="hat-visual">
            <div class="hat-dir up" id="js2-hat-up">&blacktriangle;</div>
            <div class="hat-dir down" id="js2-hat-down">&blacktriangledown;</div>
            <div class="hat-dir left" id="js2-hat-left">&#9664;</div>
            <div class="hat-dir right" id="js2-hat-right">&#9654;</div>
            <div class="hat-center"></div>
          </div>
          <div class="hat-labels">
            <div class="hat-label-row" id="js2-hat-label-up"><span class="dir-tag">&blacktriangle;</span> <span class="action-name">hat1_up</span></div>
            <div class="hat-label-row" id="js2-hat-label-right"><span class="dir-tag">&#9654;</span> <span class="action-name">hat1_right</span></div>
            <div class="hat-label-row" id="js2-hat-label-down"><span class="dir-tag">&blacktriangledown;</span> <span class="action-name">hat1_down</span></div>
            <div class="hat-label-row" id="js2-hat-label-left"><span class="dir-tag">&#9664;</span> <span class="action-name">hat1_left</span></div>
          </div>
        </div>
      </div>
      <div class="buttons-section"><h3>Buttons</h3><div class="buttons-grid" id="js2-buttons"></div></div>
    </div>
  </div>
</div>
<div id="log-panel" style="max-width:1400px; margin:0 auto; padding:0 1rem 1rem;">
  <div class="device-panel"><div class="device-content"><div class="action-log"><h3>Live Action Log</h3><div class="log-entries" id="action-log"></div></div></div></div>
</div>
</div>

<!-- ===== BIND MODE ===== -->
<div id="bind-mode" style="display:none;">
  <div class="bind-toolbar">
    <span class="toolbar-label" style="color:var(--dim); font-size:0.75rem;">Profile:</span>
    <input type="text" class="profile-name" id="profile-name-input" value="T16000m_HOTAS_Custom" placeholder="Profile name">
    <div class="separator"></div>
    <label class="bind-toolbar" style="margin:0;">
      <input type="file" id="import-xml-input" accept=".xml">
      &#128194; Import XML
    </label>
    <button onclick="exportXML()">&#128190; Export XML</button>
    <button class="primary" onclick="downloadXML()">&#11015; Download XML</button>
    <div class="separator"></div>
    <button class="danger" onclick="clearAllBindings()">&#128465; Clear All</button>
    <button onclick="clearSavedData()" title="Clear saved data from browser storage" style="font-size:0.7rem; opacity:0.7;">Clear Saved</button>
    <div class="separator"></div>
    <input type="text" id="bind-search" placeholder="Search actions..." style="width:180px; padding:0.4rem 0.6rem; background:var(--surface); border:1px solid var(--border); border-radius:6px; color:var(--fg); font-size:0.8rem;">
    <select id="bind-filter-type" style="padding:0.4rem; background:var(--surface); border:1px solid var(--border); border-radius:6px; color:var(--fg); font-size:0.75rem;">
      <option value="all">All Types</option>
      <option value="axis">Axes Only</option>
      <option value="button">Buttons Only</option>
    </select>
    <select id="bind-filter-status" style="padding:0.4rem; background:var(--surface); border:1px solid var(--border); border-radius:6px; color:var(--fg); font-size:0.75rem;">
      <option value="all">All</option>
      <option value="bound">Bound</option>
      <option value="unbound">Unbound</option>
      <option value="conflict">Conflicts</option>
    </select>
    <select id="bind-filter-tier" style="padding:0.4rem; background:var(--surface); border:1px solid var(--border); border-radius:6px; color:var(--fg); font-size:0.75rem;">
      <option value="essential">Essential Only</option>
      <option value="extended" selected>Essential + Extended</option>
      <option value="advanced">Show All</option>
    </select>
  </div>
  <div class="bind-container">
    <div class="bind-categories" id="bind-categories"></div>
    <div class="bind-sidebar">
      <div class="live-monitor">
        <h3>Live Input</h3>
        <div class="live-input-display" id="live-input-display">Waiting for input...</div>
        <div id="bind-mini-js1">
          <div class="mini-device-label">JS1 &mdash; Joystick</div>
          <div id="bind-mini-js1-axes"></div>
          <div class="mini-buttons-grid" id="bind-mini-js1-btns"></div>
        </div>
        <div id="bind-mini-js2">
          <div class="mini-device-label">JS2 &mdash; Throttle</div>
          <div id="bind-mini-js2-axes"></div>
          <div class="mini-buttons-grid" id="bind-mini-js2-btns"></div>
        </div>
      </div>
      <div class="live-monitor">
        <h3>Stats</h3>
        <div style="font-size:0.8rem; color:var(--dim); line-height:1.8;">
          <div>Bound actions: <span id="stats-bound" style="color:var(--accent);">0</span></div>
          <div>Unbound: <span id="stats-unbound" style="color:var(--dim);">0</span></div>
          <div>Conflicts: <span id="stats-conflicts" style="color:var(--danger);">0</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Export modal -->
<div class="modal-overlay hidden" id="export-modal">
  <div class="modal">
    <h2>Export Star Citizen Profile</h2>
    <pre id="export-preview"></pre>
    <div class="modal-actions">
      <button onclick="closeExportModal()">Close</button>
      <button onclick="copyXMLToClipboard()">Copy to Clipboard</button>
      <button class="primary" onclick="downloadXML()">Download .xml</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<footer>SC HOTAS Tool &bull; Gamepad API &bull; No data leaves your machine &bull; Works with any joystick/throttle</footer>

<script>
// ==============================================================
// DEVICE DATABASE
// ==============================================================
// Each entry: regex pattern (tested against gamepad.id) → device profile
// scAxisFormat maps Gamepad API axis index → SC axis name for XML export
const DEVICE_DB = [
  {
    pattern: /t\.?16000m|t16000|16000m/i,
    name: 'T.16000M FCS Joystick',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz' },
    defaultRole: 'js1'
  },
  {
    pattern: /twcs|t\.?16000.*throttle/i,
    name: 'TWCS Throttle',
    type: 'throttle',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'z', 3: 'rotx' },
    defaultRole: 'js2'
  },
  {
    pattern: /vkb.*gladiator|vkb-sim.*gladiator/i,
    name: 'VKB Gladiator NXT',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz' },
    defaultRole: 'js1'
  },
  {
    pattern: /virpil.*constellation|vpc.*constellation/i,
    name: 'VirPil Constellation',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz' },
    defaultRole: 'js1'
  },
  {
    pattern: /virpil.*cm[23]|vpc.*throttle/i,
    name: 'VirPil Throttle',
    type: 'throttle',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'z', 3: 'rotx', 4: 'roty', 5: 'slider1' },
    defaultRole: 'js2'
  },
  {
    pattern: /logitech.*extreme.*3d|extreme 3d pro/i,
    name: 'Logitech Extreme 3D Pro',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz', 3: 'z' },
    defaultRole: 'js1'
  },
  {
    pattern: /x52|saitek.*x52/i,
    name: 'Saitek X52',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz', 3: 'z', 4: 'rotx', 5: 'roty', 6: 'slider1' },
    defaultRole: 'js1'
  },
  {
    pattern: /x56|saitek.*x56/i,
    name: 'Logitech X56',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz', 3: 'z', 4: 'rotx', 5: 'roty', 6: 'slider1', 7: 'slider2' },
    defaultRole: 'js1'
  },
  {
    pattern: /ch.*fighterstick|ch.*combatstick/i,
    name: 'CH Products Fighterstick',
    type: 'joystick',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'rotz' },
    defaultRole: 'js1'
  },
  {
    pattern: /ch.*throttle/i,
    name: 'CH Products Pro Throttle',
    type: 'throttle',
    scAxisFormat: { 0: 'x', 1: 'y', 2: 'z', 3: 'rotx' },
    defaultRole: 'js2'
  }
];

const DEFAULT_DEVICE_PROFILE = {
  name: 'Unknown Device',
  type: 'generic',
  scAxisFormat: {},  // will use generic axis0, axis1, etc.
  defaultRole: null
};

function identifyDevice(gamepad) {
  if (!gamepad) return DEFAULT_DEVICE_PROFILE;
  const id = gamepad.id;
  for (const entry of DEVICE_DB) {
    if (entry.pattern.test(id)) return entry;
  }
  return DEFAULT_DEVICE_PROFILE;
}

// ==============================================================
// SC ACTIONS DATABASE
// ==============================================================
// 455 HOTAS-relevant actions from AllBinds.xml (23 categories)
const SC_ACTIONS = {
  spaceship_movement: {
    label: 'Flight Movement',
    actions: [
      { name: 'v_pitch_up', label: 'Pitch Up', type: 'button', tier: 'extended' },
      { name: 'v_pitch_down', label: 'Pitch Down', type: 'button', tier: 'extended' },
      { name: 'v_pitch', label: 'Pitch', type: 'axis', tier: 'essential', optionGroup: 'flight_move_pitch' },
      { name: 'v_yaw_left', label: 'Yaw Left', type: 'button', tier: 'extended' },
      { name: 'v_yaw_right', label: 'Yaw Right', type: 'button', tier: 'extended' },
      { name: 'v_yaw', label: 'Yaw', type: 'axis', tier: 'essential', optionGroup: 'flight_move_yaw' },
      { name: 'v_roll_left', label: 'Roll Left', type: 'button', tier: 'extended' },
      { name: 'v_roll_right', label: 'Roll Right', type: 'button', tier: 'extended' },
      { name: 'v_roll', label: 'Roll', type: 'axis', tier: 'essential', optionGroup: 'flight_move_roll' },
      { name: 'v_toggle_relative_mouse_mode', label: 'Toggle Relative Mouse Mode', type: 'button', tier: 'extended' },
      { name: 'v_toggle_yaw_roll_swap', label: 'Toggle Yaw Roll Swap', type: 'button', tier: 'extended' },
      { name: 'v_strafe_up', label: 'Strafe Up', type: 'axis', tier: 'extended', optionGroup: 'flight_move_strafe_vertical' },
      { name: 'v_strafe_down', label: 'Strafe Down', type: 'axis', tier: 'extended', optionGroup: 'flight_move_strafe_vertical' },
      { name: 'v_strafe_vertical', label: 'Strafe Up/Down', type: 'axis', tier: 'essential', optionGroup: 'flight_move_strafe_vertical' },
      { name: 'v_strafe_left', label: 'Strafe Left', type: 'axis', tier: 'extended', optionGroup: 'flight_move_strafe_lateral' },
      { name: 'v_strafe_right', label: 'Strafe Right', type: 'axis', tier: 'extended', optionGroup: 'flight_move_strafe_lateral' },
      { name: 'v_strafe_lateral', label: 'Strafe Left/Right', type: 'axis', tier: 'essential', optionGroup: 'flight_move_strafe_lateral' },
      { name: 'v_strafe_forward', label: 'Strafe Forward', type: 'axis', tier: 'extended', optionGroup: 'flight_strafe_forward' },
      { name: 'v_strafe_back', label: 'Strafe Back', type: 'axis', tier: 'extended', optionGroup: 'flight_strafe_backward' },
      { name: 'v_strafe_longitudinal', label: 'Throttle (Fwd/Back)', type: 'axis', tier: 'essential', optionGroup: 'flight_strafe_longitudinal' },
      { name: 'v_strafe_longitudinal_invert', label: 'Strafe Longitudinal Invert', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_throttle_swap_mode', label: 'Ifcs Throttle Swap Mode', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_throttle_set_sticky', label: 'Ifcs Throttle Set Sticky', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_throttle_set_normal', label: 'Ifcs Throttle Set Normal', type: 'button', tier: 'extended' },
      { name: 'v_strafe_trim_set_long', label: 'Strafe Trim Set Long', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_set_short', label: 'Strafe Trim Set Short', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_set_100_long', label: 'Strafe Trim Set 100 Long', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_set_100_short', label: 'Strafe Trim Set 100 Short', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_set_50_long', label: 'Strafe Trim Set 50 Long', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_set_50_short', label: 'Strafe Trim Set 50 Short', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_reset_long', label: 'Strafe Trim Reset Long', type: 'button', tier: 'advanced' },
      { name: 'v_strafe_trim_reset_short', label: 'Strafe Trim Reset Short', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_vector_decoupling_toggle', label: 'Decoupled Toggle', type: 'button', tier: 'essential' },
      { name: 'v_ifcs_vector_decoupling_on', label: 'Decoupled On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_vector_decoupling_off', label: 'Decoupled Off', type: 'button', tier: 'advanced' },
      { name: 'v_afterburner', label: 'Afterburner', type: 'button', tier: 'essential' },
      { name: 'v_ifcs_speed_limiter_up', label: 'Ifcs Speed Limiter Up', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_speed_limiter_down', label: 'Ifcs Speed Limiter Down', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_speed_limiter_increment', label: 'Ifcs Speed Limiter Increment', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_speed_limiter_decrement', label: 'Ifcs Speed Limiter Decrement', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_speed_limiter_rel', label: 'Speed Limiter (Relative)', type: 'axis', tier: 'essential', optionGroup: 'flight_move_speed_range_rel' },
      { name: 'v_ifcs_speed_limiter_abs', label: 'Speed Limiter (Absolute)', type: 'axis', tier: 'essential', optionGroup: 'flight_move_speed_range_abs' },
      { name: 'v_ifcs_speed_limiter_toggle', label: 'Speed Limiter Toggle', type: 'button', tier: 'essential' },
      { name: 'v_ifcs_speed_limiter_on', label: 'Ifcs Speed Limiter On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_speed_limiter_off', label: 'Ifcs Speed Limiter Off', type: 'button', tier: 'advanced' },
      { name: 'v_accel_range_up', label: 'Accel Range Up', type: 'button', tier: 'extended' },
      { name: 'v_accel_range_down', label: 'Accel Range Down', type: 'button', tier: 'extended' },
      { name: 'v_accel_range_increment', label: 'Accel Range Increment', type: 'button', tier: 'extended' },
      { name: 'v_accel_range_decrement', label: 'Accel Range Decrement', type: 'button', tier: 'extended' },
      { name: 'v_accel_range_rel', label: 'Accel Range (Relative)', type: 'axis', tier: 'essential', optionGroup: 'flight_move_accel_range_rel' },
      { name: 'v_accel_range_abs', label: 'Accel Range (Absolute)', type: 'axis', tier: 'essential', optionGroup: 'flight_move_accel_range_abs' },
      { name: 'v_space_brake', label: 'Space Brake', type: 'axis', tier: 'essential', optionGroup: 'flight_move_space_brake' },
      { name: 'v_lock_rotation', label: 'Lock Rotation', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_gsafe_on', label: 'Ifcs Gsafe On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_gsafe_off', label: 'Ifcs Gsafe Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_toggle_gforce_safety', label: 'G-Force Safety Toggle', type: 'button', tier: 'essential' },
      { name: 'v_ifcs_toggle_esp', label: 'ESP Toggle', type: 'button', tier: 'essential' },
      { name: 'v_ifcs_esp_hold', label: 'ESP Hold', type: 'button', tier: 'advanced' },
      { name: 'v_toggle_landing_system', label: 'Landing Gear Toggle', type: 'button', tier: 'essential' },
      { name: 'v_deploy_landing_system', label: 'Deploy Landing Gear', type: 'button', tier: 'extended' },
      { name: 'v_retract_landing_system', label: 'Retract Landing Gear', type: 'button', tier: 'extended' },
      { name: 'v_vtol_toggle', label: 'VTOL Toggle', type: 'button', tier: 'essential' },
      { name: 'v_vtol_on', label: 'VTOL On', type: 'button', tier: 'advanced' },
      { name: 'v_vtol_off', label: 'VTOL Off', type: 'button', tier: 'advanced' },
      { name: 'v_transform_deploy', label: 'Transform Deploy', type: 'button', tier: 'extended' },
      { name: 'v_transform_retract', label: 'Transform Retract', type: 'button', tier: 'extended' },
      { name: 'v_transform_cycle', label: 'Transform Cycle', type: 'button', tier: 'extended' },
      { name: 'v_autoland', label: 'Auto Land', type: 'button', tier: 'essential' },
      { name: 'v_atc_request', label: 'ATC Request', type: 'button', tier: 'extended' },
      { name: 'v_atc_loading_area_request', label: 'Atc Loading Area Request', type: 'button', tier: 'extended' },
      { name: 'v_master_mode_cycle', label: 'Master Mode Cycle', type: 'button', tier: 'essential' },
      { name: 'v_master_mode_cycle_long', label: 'Master Mode Cycle Long', type: 'button', tier: 'advanced' },
      { name: 'v_master_mode_set_nav', label: 'Master Mode: NAV', type: 'button', tier: 'essential' },
      { name: 'v_master_mode_set_scm', label: 'Master Mode: SCM', type: 'button', tier: 'essential' },
      { name: 'v_toggle_jump_request', label: 'Toggle Jump Request', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_gravity_compensation_toggle', label: 'Ifcs Gravity Compensation Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_gravity_compensation_on', label: 'Ifcs Gravity Compensation On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_gravity_compensation_off', label: 'Ifcs Gravity Compensation Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_wind_compensation_toggle', label: 'Ifcs Wind Compensation Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_wind_compensation_on', label: 'Ifcs Wind Compensation On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_wind_compensation_off', label: 'Ifcs Wind Compensation Off', type: 'button', tier: 'advanced' },
      { name: 'v_auto_precision_mode_toggle', label: 'Auto Precision Mode Toggle', type: 'button', tier: 'extended' },
      { name: 'v_auto_precision_mode_on', label: 'Auto Precision Mode On', type: 'button', tier: 'advanced' },
      { name: 'v_auto_precision_mode_off', label: 'Auto Precision Mode Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_proximity_assist_toggle', label: 'Ifcs Proximity Assist Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_proximity_assist_on', label: 'Ifcs Proximity Assist On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_proximity_assist_off', label: 'Ifcs Proximity Assist Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_stability_toggle', label: 'Ifcs Stability Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_stability_on', label: 'Ifcs Stability On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_stability_off', label: 'Ifcs Stability Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_command_toggle', label: 'Ifcs Command Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_command_on', label: 'Ifcs Command On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_command_off', label: 'Ifcs Command Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_core_toggle', label: 'Ifcs Core Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ifcs_core_on', label: 'Ifcs Core On', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_core_off', label: 'Ifcs Core Off', type: 'button', tier: 'advanced' },
      { name: 'v_ifcs_reset_gmeter_max', label: 'Ifcs Reset Gmeter Max', type: 'button', tier: 'advanced' },
      { name: 'v_flight_advanced_hud_toggle', label: 'Flight Advanced Hud Toggle', type: 'button', tier: 'extended' },
      { name: 'v_flight_advanced_hud_on', label: 'Flight Advanced Hud On', type: 'button', tier: 'advanced' },
      { name: 'v_flight_advanced_hud_off', label: 'Flight Advanced Hud Off', type: 'button', tier: 'advanced' },
    ]
  },
  spaceship_weapons: {
    label: 'Weapons',
    actions: [
      { name: 'v_weapon_gimbals_state_toggle', label: 'Gimbal Lock Toggle', type: 'button', tier: 'essential' },
      { name: 'v_weapon_gimbals_state_set_locked', label: 'Weapon Gimbals State Set Locked', type: 'button', tier: 'extended' },
      { name: 'v_weapon_gimbals_state_set_unlocked', label: 'Weapon Gimbals State Set Unlocked', type: 'button', tier: 'extended' },
      { name: 'v_weapon_gimbals_unlocked_cycle_source', label: 'Weapon Gimbals Unlocked Cycle Source', type: 'button', tier: 'extended' },
      { name: 'v_weapon_aim_type_cycle', label: 'Weapon Aim Type Cycle', type: 'button', tier: 'extended' },
      { name: 'v_weapon_aim_type_set_pip_aiming', label: 'Weapon Aim Type Set Pip Aiming', type: 'button', tier: 'extended' },
      { name: 'v_weapon_aim_type_set_painting', label: 'Weapon Aim Type Set Painting', type: 'button', tier: 'extended' },
      { name: 'v_weapon_aim_type_set_auto', label: 'Weapon Aim Type Set Auto', type: 'button', tier: 'extended' },
      { name: 'v_weapon_staggered_fire_toggle', label: 'Staggered Fire Toggle', type: 'button', tier: 'essential' },
      { name: 'v_weapon_staggered_fire_on', label: 'Weapon Staggered Fire On', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_staggered_fire_off', label: 'Weapon Staggered Fire Off', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_suppress_aim_assists_hold', label: 'Weapon Suppress Aim Assists Hold', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_pip_toggle_lead_lag', label: 'Weapon Pip Toggle Lead Lag', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_set_lag', label: 'Weapon Pip Set Lag', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_set_lead', label: 'Weapon Pip Set Lead', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_combination_type_toggle', label: 'Weapon Pip Combination Type Toggle', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_combination_type_set_single', label: 'Weapon Pip Combination Type Set Single', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_combination_type_set_combined_weapon_group', label: 'Weapon Pip Combination Type Set Combined Weapon Group', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_prec_line_toggle', label: 'Weapon Pip Prec Line Toggle', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_prec_line_on', label: 'Weapon Pip Prec Line On', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_pip_prec_line_off', label: 'Weapon Pip Prec Line Off', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_pip_fade_toggle', label: 'Weapon Pip Fade Toggle', type: 'button', tier: 'extended' },
      { name: 'v_weapon_pip_fade_on', label: 'Weapon Pip Fade On', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_pip_fade_off', label: 'Weapon Pip Fade Off', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_ui_scale_toggle', label: 'Weapon Ui Scale Toggle', type: 'button', tier: 'extended' },
      { name: 'v_weapon_ui_scale_on', label: 'Weapon Ui Scale On', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_ui_scale_off', label: 'Weapon Ui Scale Off', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_convergence_distance_rel', label: 'Weapon Convergence Distance Rel', type: 'axis', tier: 'extended', optionGroup: 'weapon_convergence_distance_rel' },
      { name: 'v_weapon_convergence_distance_rel_increase', label: 'Weapon Convergence Distance Rel Increase', type: 'button', tier: 'extended' },
      { name: 'v_weapon_convergence_distance_rel_decrease', label: 'Weapon Convergence Distance Rel Decrease', type: 'button', tier: 'extended' },
      { name: 'v_weapon_convergence_distance_abs', label: 'Weapon Convergence Distance Abs', type: 'axis', tier: 'extended', optionGroup: 'weapon_convergence_distance_abs' },
      { name: 'v_weapon_convergence_distance_set_default', label: 'Weapon Convergence Distance Set Default', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_attack', label: 'Fire Weapons', type: 'button', tier: 'essential' },
      { name: 'v_weapon_preset_fire_guns0', label: 'Weapon Preset Fire Guns0', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_fire_guns1', label: 'Weapon Preset Fire Guns1', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_fire_guns2', label: 'Weapon Preset Fire Guns2', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_fire_guns3', label: 'Weapon Preset Fire Guns3', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_next', label: 'Next Weapon Group', type: 'button', tier: 'essential' },
      { name: 'v_weapon_preset_prev', label: 'Prev Weapon Group', type: 'button', tier: 'essential' },
      { name: 'v_weapon_preset_next_overflow', label: 'Weapon Preset Next Overflow', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_prev_overflow', label: 'Weapon Preset Prev Overflow', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_guns0', label: 'Weapon Preset Guns0', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_guns1', label: 'Weapon Preset Guns1', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_guns2', label: 'Weapon Preset Guns2', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_guns3', label: 'Weapon Preset Guns3', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_emp', label: 'Weapon Preset Emp', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_qid_jammer', label: 'Weapon Preset Qid Jammer', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_qid_pulse', label: 'Weapon Preset Qid Pulse', type: 'button', tier: 'extended' },
      { name: 'v_weapon_preset_qid', label: 'Weapon Preset Qid', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_missiles: {
    label: 'Missiles',
    actions: [
      { name: 'v_weapon_toggle_launch_missile', label: 'Toggle Launch Missile', type: 'button', tier: 'essential' },
      { name: 'v_weapon_launch_missile', label: 'Launch Missile', type: 'button', tier: 'essential' },
      { name: 'v_weapon_cycle_missile_fwd', label: 'Cycle Missile Fwd', type: 'button', tier: 'essential' },
      { name: 'v_weapon_cycle_missile_back', label: 'Cycle Missile Back', type: 'button', tier: 'essential' },
      { name: 'v_weapon_increase_max_missiles', label: 'Weapon Increase Max Missiles', type: 'button', tier: 'extended' },
      { name: 'v_weapon_decrease_max_missiles', label: 'Weapon Decrease Max Missiles', type: 'button', tier: 'extended' },
      { name: 'v_weapon_reset_max_missiles', label: 'Weapon Reset Max Missiles', type: 'button', tier: 'extended' },
      { name: 'v_weapon_bombing_toggle_desired_impact_point', label: 'Weapon Bombing Toggle Desired Impact Point', type: 'button', tier: 'extended' },
      { name: 'v_weapon_bombing_toggle_desired_impact_point_hold', label: 'Weapon Bombing Toggle Desired Impact Point Hold', type: 'button', tier: 'advanced' },
      { name: 'v_weapon_bombing_hud_range_increase', label: 'Weapon Bombing Hud Range Increase', type: 'button', tier: 'extended' },
      { name: 'v_weapon_bombing_hud_range_decrease', label: 'Weapon Bombing Hud Range Decrease', type: 'button', tier: 'extended' },
      { name: 'v_weapon_bombing_hud_range_reset', label: 'Weapon Bombing Hud Range Reset', type: 'button', tier: 'extended' },
      { name: 'v_weapon_launch_missile_cinematic', label: 'Weapon Launch Missile Cinematic', type: 'button', tier: 'extended' },
      { name: 'v_weapon_launch_missile_cinematic_hold', label: 'Weapon Launch Missile Cinematic Hold', type: 'button', tier: 'advanced' },
    ]
  },
  spaceship_defensive: {
    label: 'Defensive & Shields',
    actions: [
      { name: 'v_weapon_countermeasure_decoy_launch', label: 'Launch Decoy', type: 'button', tier: 'essential' },
      { name: 'v_weapon_countermeasure_decoy_burst_increase', label: 'Weapon Countermeasure Decoy Burst Increase', type: 'button', tier: 'extended' },
      { name: 'v_weapon_countermeasure_decoy_burst_decrease', label: 'Weapon Countermeasure Decoy Burst Decrease', type: 'button', tier: 'extended' },
      { name: 'v_weapon_countermeasure_decoy_launch_panic', label: 'Weapon Countermeasure Decoy Launch Panic', type: 'button', tier: 'extended' },
      { name: 'v_weapon_countermeasure_noise_launch', label: 'Launch Noise', type: 'button', tier: 'essential' },
      { name: 'v_shield_raise_level_forward', label: 'Shield Forward', type: 'button', tier: 'essential' },
      { name: 'v_shield_raise_level_back', label: 'Shield Rear', type: 'button', tier: 'essential' },
      { name: 'v_shield_raise_level_left', label: 'Shield Left', type: 'button', tier: 'essential' },
      { name: 'v_shield_raise_level_right', label: 'Shield Right', type: 'button', tier: 'essential' },
      { name: 'v_shield_raise_level_up', label: 'Shield Up', type: 'button', tier: 'extended' },
      { name: 'v_shield_raise_level_down', label: 'Shield Down', type: 'button', tier: 'extended' },
      { name: 'v_shield_reset_level', label: 'Shield Reset', type: 'button', tier: 'essential' },
    ]
  },
  spaceship_targeting_advanced: {
    label: 'Targeting',
    actions: [
      { name: 'v_target_under_reticle', label: 'Target Under Reticle', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_in_view_back', label: 'Target Cycle In View Back', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_in_view_fwd', label: 'Target Cycle In View Fwd', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_in_view_reset', label: 'Target Cycle In View Reset', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_pinned_back', label: 'Target Cycle Pinned Back', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_pinned_fwd', label: 'Target Cycle Pinned Fwd', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_pinned_reset', label: 'Target Cycle Pinned Reset', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_attacker_back', label: 'Target Cycle Attacker Back', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_attacker_fwd', label: 'Target Cycle Attacker Fwd', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_attacker_reset', label: 'Target Cycle Attacker Reset', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_hostile_back', label: 'Cycle Hostile Back', type: 'button', tier: 'essential' },
      { name: 'v_target_cycle_hostile_fwd', label: 'Cycle Hostile Fwd', type: 'button', tier: 'essential' },
      { name: 'v_target_cycle_hostile_reset', label: 'Target Cycle Hostile Reset', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_friendly_back', label: 'Cycle Friendly Back', type: 'button', tier: 'essential' },
      { name: 'v_target_cycle_friendly_fwd', label: 'Cycle Friendly Fwd', type: 'button', tier: 'essential' },
      { name: 'v_target_cycle_friendly_reset', label: 'Target Cycle Friendly Reset', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_all_back', label: 'Target Cycle All Back', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_all_fwd', label: 'Target Cycle All Fwd', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_all_reset', label: 'Target Cycle All Reset', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_subitem_back', label: 'Target Cycle Subitem Back', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_subitem_fwd', label: 'Target Cycle Subitem Fwd', type: 'button', tier: 'extended' },
      { name: 'v_target_cycle_subitem_reset', label: 'Target Cycle Subitem Reset', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_targeting: {
    label: 'Targeting (Legacy)',
    actions: [
      { name: 'v_auto_targeting_toggle_long', label: 'Auto Targeting Toggle Long', type: 'button', tier: 'advanced' },
      { name: 'v_auto_targeting_toggle_short', label: 'Auto Targeting Toggle Short', type: 'button', tier: 'advanced' },
      { name: 'v_auto_targeting_enable_short', label: 'Auto Targeting Enable Short', type: 'button', tier: 'advanced' },
      { name: 'v_auto_targeting_enable_long', label: 'Auto Targeting Enable Long', type: 'button', tier: 'advanced' },
      { name: 'v_auto_targeting_disable_short', label: 'Auto Targeting Disable Short', type: 'button', tier: 'advanced' },
      { name: 'v_auto_targeting_disable_long', label: 'Auto Targeting Disable Long', type: 'button', tier: 'advanced' },
      { name: 'v_target_toggle_lock_index_1', label: 'Target Toggle Lock Index 1', type: 'button', tier: 'extended' },
      { name: 'v_target_toggle_lock_index_2', label: 'Target Toggle Lock Index 2', type: 'button', tier: 'extended' },
      { name: 'v_target_toggle_lock_index_3', label: 'Target Toggle Lock Index 3', type: 'button', tier: 'extended' },
      { name: 'v_target_toggle_pin_index_1', label: 'Target Toggle Pin Index 1', type: 'button', tier: 'extended' },
      { name: 'v_target_toggle_pin_index_2', label: 'Target Toggle Pin Index 2', type: 'button', tier: 'extended' },
      { name: 'v_target_toggle_pin_index_3', label: 'Target Toggle Pin Index 3', type: 'button', tier: 'extended' },
      { name: 'v_target_toggle_pin_index_1_hold', label: 'Target Toggle Pin Index 1 Hold', type: 'button', tier: 'advanced' },
      { name: 'v_target_toggle_pin_index_2_hold', label: 'Target Toggle Pin Index 2 Hold', type: 'button', tier: 'advanced' },
      { name: 'v_target_toggle_pin_index_3_hold', label: 'Target Toggle Pin Index 3 Hold', type: 'button', tier: 'advanced' },
      { name: 'v_target_pin_selected', label: 'Pin Target', type: 'button', tier: 'essential' },
      { name: 'v_target_unpin_selected', label: 'Unpin Target', type: 'button', tier: 'extended' },
      { name: 'v_target_pin_selected_hold', label: 'Target Pin Selected Hold', type: 'button', tier: 'advanced' },
      { name: 'v_target_unpin_selected_hold', label: 'Target Unpin Selected Hold', type: 'button', tier: 'advanced' },
      { name: 'v_target_remove_all_pins', label: 'Target Remove All Pins', type: 'button', tier: 'extended' },
      { name: 'v_target_lock_selected', label: 'Lock Target', type: 'button', tier: 'essential' },
      { name: 'v_target_unlock', label: 'Unlock Target', type: 'button', tier: 'extended' },
      { name: 'v_look_ahead_enable', label: 'Look Ahead Enable', type: 'button', tier: 'extended' },
      { name: 'v_look_ahead_start_target_tracking', label: 'Look Ahead Start Target Tracking', type: 'button', tier: 'extended' },
      { name: 'v_target_tracking_auto_zoom', label: 'Target Tracking Auto Zoom', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_scanning: {
    label: 'Scanning',
    actions: [
      { name: 'v_scanning_trigger_scan', label: 'Trigger Scan', type: 'button', tier: 'essential' },
      { name: 'v_inc_scan_focus_level', label: 'Inc Scan Focus Level', type: 'button', tier: 'extended' },
      { name: 'v_dec_scan_focus_level', label: 'Dec Scan Focus Level', type: 'button', tier: 'extended' },
      { name: 'v_ui_prev_scan_tab', label: 'Ui Prev Scan Tab', type: 'button', tier: 'extended' },
      { name: 'v_ui_next_scan_tab', label: 'Ui Next Scan Tab', type: 'button', tier: 'extended' },
      { name: 'v_ui_prev_scan_page', label: 'Ui Prev Scan Page', type: 'button', tier: 'extended' },
      { name: 'v_ui_next_scan_page', label: 'Ui Next Scan Page', type: 'button', tier: 'extended' },
      { name: 'v_ui_prev_contact_page', label: 'Ui Prev Contact Page', type: 'button', tier: 'extended' },
      { name: 'v_ui_next_contact_page', label: 'Ui Next Contact Page', type: 'button', tier: 'extended' },
      { name: 'v_ui_prev_contact', label: 'Ui Prev Contact', type: 'button', tier: 'extended' },
      { name: 'v_ui_next_contact', label: 'Ui Next Contact', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_radar: {
    label: 'Radar',
    actions: [
      { name: 'v_invoke_ping', label: 'Radar Ping', type: 'button', tier: 'essential' },
    ]
  },
  spaceship_power: {
    label: 'Power & Engineering',
    actions: [
      { name: 'v_power_toggle', label: 'Power Toggle', type: 'button', tier: 'essential' },
      { name: 'v_power_set_on', label: 'Power Set On', type: 'button', tier: 'advanced' },
      { name: 'v_power_set_off', label: 'Power Set Off', type: 'button', tier: 'advanced' },
      { name: 'v_power_toggle_thrusters', label: 'Power Toggle Thrusters', type: 'button', tier: 'extended' },
      { name: 'v_power_set_thrusters_on', label: 'Power Set Thrusters On', type: 'button', tier: 'advanced' },
      { name: 'v_power_set_thrusters_off', label: 'Power Set Thrusters Off', type: 'button', tier: 'advanced' },
      { name: 'v_power_toggle_shields', label: 'Power Toggle Shields', type: 'button', tier: 'extended' },
      { name: 'v_power_set_shields_on', label: 'Power Set Shields On', type: 'button', tier: 'advanced' },
      { name: 'v_power_set_shields_off', label: 'Power Set Shields Off', type: 'button', tier: 'advanced' },
      { name: 'v_power_toggle_weapons', label: 'Power Toggle Weapons', type: 'button', tier: 'extended' },
      { name: 'v_power_set_weapons_on', label: 'Power Set Weapons On', type: 'button', tier: 'advanced' },
      { name: 'v_power_set_weapons_off', label: 'Power Set Weapons Off', type: 'button', tier: 'advanced' },
      { name: 'v_power_throttle_down', label: 'Power Throttle Down', type: 'button', tier: 'extended' },
      { name: 'v_power_throttle_min', label: 'Power Throttle Min', type: 'button', tier: 'advanced' },
      { name: 'v_power_throttle_up', label: 'Power Throttle Up', type: 'button', tier: 'extended' },
      { name: 'v_power_throttle_max', label: 'Power Throttle Max', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_engine_increase', label: 'Engineering Assignment Engine Increase', type: 'button', tier: 'extended' },
      { name: 'v_engineering_assignment_engine_decrease', label: 'Engineering Assignment Engine Decrease', type: 'button', tier: 'extended' },
      { name: 'v_engineering_assignment_engine_max', label: 'Engineering Assignment Engine Max', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_engine_min', label: 'Engineering Assignment Engine Min', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_shields_increase', label: 'Engineering Assignment Shields Increase', type: 'button', tier: 'extended' },
      { name: 'v_engineering_assignment_shields_decrease', label: 'Engineering Assignment Shields Decrease', type: 'button', tier: 'extended' },
      { name: 'v_engineering_assignment_shields_max', label: 'Engineering Assignment Shields Max', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_shields_min', label: 'Engineering Assignment Shields Min', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_weapons_increase', label: 'Engineering Assignment Weapons Increase', type: 'button', tier: 'extended' },
      { name: 'v_engineering_assignment_weapons_decrease', label: 'Engineering Assignment Weapons Decrease', type: 'button', tier: 'extended' },
      { name: 'v_engineering_assignment_weapons_max', label: 'Engineering Assignment Weapons Max', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_weapons_min', label: 'Engineering Assignment Weapons Min', type: 'button', tier: 'advanced' },
      { name: 'v_engineering_assignment_reset', label: 'Engineering Reset', type: 'button', tier: 'essential' },
    ]
  },
  spaceship_general: {
    label: 'General Ship',
    actions: [
      { name: 'v_self_destruct', label: 'Self Destruct', type: 'button', tier: 'extended' },
      { name: 'v_cooler_throttle_up', label: 'Cooler Throttle Up', type: 'button', tier: 'extended' },
      { name: 'v_cooler_throttle_down', label: 'Cooler Throttle Down', type: 'button', tier: 'extended' },
      { name: 'spectate_enterpuremode', label: 'Spectate Enterpuremode', type: 'button', tier: 'extended' },
      { name: 'v_flightready', label: 'Flight Ready', type: 'button', tier: 'essential' },
      { name: 'v_toggle_all_doors', label: 'Toggle All Doors', type: 'button', tier: 'extended' },
      { name: 'v_open_all_doors', label: 'Open All Doors', type: 'button', tier: 'extended' },
      { name: 'v_close_all_doors', label: 'Close All Doors', type: 'button', tier: 'extended' },
      { name: 'v_toggle_all_doorlocks', label: 'Toggle All Doorlocks', type: 'button', tier: 'extended' },
      { name: 'v_lock_all_doors', label: 'Lock All Doors', type: 'button', tier: 'extended' },
      { name: 'v_unlock_all_doors', label: 'Unlock All Doors', type: 'button', tier: 'extended' },
      { name: 'v_toggle_all_portlocks', label: 'Toggle All Portlocks', type: 'button', tier: 'extended' },
      { name: 'v_lock_all_ports', label: 'Lock All Ports', type: 'button', tier: 'extended' },
      { name: 'v_unlock_all_ports', label: 'Unlock All Ports', type: 'button', tier: 'extended' },
      { name: 'pc_conversation_option1', label: 'Pc Conversation Option1', type: 'button', tier: 'extended' },
      { name: 'pc_conversation_option2', label: 'Pc Conversation Option2', type: 'button', tier: 'extended' },
      { name: 'pc_conversation_option3', label: 'Pc Conversation Option3', type: 'button', tier: 'extended' },
      { name: 'pc_conversation_option4', label: 'Pc Conversation Option4', type: 'button', tier: 'extended' },
      { name: 'pc_conversation_option5', label: 'Pc Conversation Option5', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_view: {
    label: 'View & Camera',
    actions: [
      { name: 'v_view_yaw_left', label: 'View Yaw Left', type: 'axis', tier: 'extended', optionGroup: 'flight_view_yaw_left' },
      { name: 'v_view_yaw_right', label: 'View Yaw Right', type: 'axis', tier: 'extended', optionGroup: 'flight_view_yaw_right' },
      { name: 'v_view_yaw', label: 'View Yaw', type: 'axis', tier: 'extended', optionGroup: 'flight_view_yaw' },
      { name: 'v_view_yaw_absolute', label: 'View Yaw Absolute', type: 'button', tier: 'extended' },
      { name: 'v_view_pitch_up', label: 'View Pitch Up', type: 'axis', tier: 'extended', optionGroup: 'flight_view_pitch_up' },
      { name: 'v_view_pitch_down', label: 'View Pitch Down', type: 'axis', tier: 'extended', optionGroup: 'flight_view_pitch_down' },
      { name: 'v_view_pitch', label: 'View Pitch', type: 'axis', tier: 'extended', optionGroup: 'flight_view_pitch' },
      { name: 'v_view_pitch_absolute', label: 'View Pitch Absolute', type: 'button', tier: 'extended' },
      { name: 'v_view_roll_absolute', label: 'View Roll Absolute', type: 'button', tier: 'extended' },
      { name: 'v_view_cycle_fwd', label: 'Cycle View', type: 'button', tier: 'essential' },
      { name: 'v_view_cycle_internal_fwd', label: 'View Cycle Internal Fwd', type: 'button', tier: 'extended' },
      { name: 'v_view_option', label: 'View Option', type: 'button', tier: 'extended' },
      { name: 'v_view_mode', label: 'View Mode', type: 'button', tier: 'extended' },
      { name: 'v_view_zoom_in', label: 'Zoom In', type: 'button', tier: 'extended' },
      { name: 'v_view_zoom_out', label: 'Zoom Out', type: 'button', tier: 'extended' },
      { name: 'v_view_interact', label: 'View Interact', type: 'button', tier: 'extended' },
      { name: 'v_view_freelook_mode', label: 'Freelook Toggle', type: 'button', tier: 'essential' },
      { name: 'v_view_dynamic_zoom_rel', label: 'View Dynamic Zoom Rel', type: 'axis', tier: 'extended', optionGroup: 'flight_zoom' },
      { name: 'v_view_dynamic_zoom_rel_in', label: 'View Dynamic Zoom Rel In', type: 'button', tier: 'extended' },
      { name: 'v_view_dynamic_zoom_rel_out', label: 'View Dynamic Zoom Rel Out', type: 'button', tier: 'extended' },
      { name: 'v_view_dynamic_zoom_abs', label: 'View Dynamic Zoom Abs', type: 'axis', tier: 'extended', optionGroup: 'flight_zoom_abs' },
      { name: 'v_view_dynamic_zoom_abs_toggle', label: 'View Dynamic Zoom Abs Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ads_hold', label: 'Ads Hold', type: 'button', tier: 'advanced' },
      { name: 'v_ads_toggle', label: 'Ads Toggle', type: 'button', tier: 'extended' },
      { name: 'v_ads_stable_max_zoom_hold', label: 'Ads Stable Max Zoom Hold', type: 'button', tier: 'advanced' },
      { name: 'v_ads_cycle_tracking', label: 'Ads Cycle Tracking', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_quantum: {
    label: 'Quantum Travel',
    actions: [
      { name: 'v_toggle_qdrive_engagement', label: 'Quantum Drive Engage', type: 'button', tier: 'essential' },
    ]
  },
  spaceship_docking: {
    label: 'Docking',
    actions: [
      { name: 'v_toggle_docking_mode', label: 'Docking Mode Toggle', type: 'button', tier: 'extended' },
      { name: 'v_invoke_docking', label: 'Invoke Docking', type: 'button', tier: 'extended' },
      { name: 'v_dock_toggle_view', label: 'Dock Toggle View', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_mining: {
    label: 'Mining',
    actions: [
      { name: 'v_toggle_mining_laser_fire', label: 'Mining Laser Fire', type: 'button', tier: 'essential' },
      { name: 'v_toggle_mining_laser_type', label: 'Cycle Mining Laser Type', type: 'button', tier: 'extended' },
      { name: 'v_increase_mining_throttle', label: 'Increase Mining Throttle', type: 'button', tier: 'extended' },
      { name: 'v_decrease_mining_throttle', label: 'Decrease Mining Throttle', type: 'button', tier: 'extended' },
      { name: 'v_mining_throttle', label: 'Mining Throttle', type: 'axis', tier: 'essential', optionGroup: 'mining_throttle' },
      { name: 'v_mining_use_consumable1', label: 'Mining Use Consumable1', type: 'button', tier: 'extended' },
      { name: 'v_mining_use_consumable2', label: 'Mining Use Consumable2', type: 'button', tier: 'extended' },
      { name: 'v_mining_use_consumable3', label: 'Mining Use Consumable3', type: 'button', tier: 'extended' },
      { name: 'v_mining_use_permanent_modifier', label: 'Mining Use Permanent Modifier', type: 'button', tier: 'extended' },
      { name: 'v_jettison_volatile_cargo', label: 'Jettison Volatile Cargo', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_salvage: {
    label: 'Salvage',
    actions: [
      { name: 'tractor_beam_vehicle_increase_distance', label: 'Vehicle Increase Distance', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_vehicle_decrease_distance', label: 'Vehicle Decrease Distance', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_fire_focused', label: 'Salvage Toggle Fire Focused', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_fire_left', label: 'Salvage Toggle Fire Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_fire_right', label: 'Salvage Toggle Fire Right', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_fire_fracture', label: 'Salvage Toggle Fire Fracture', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_fire_disintegrate', label: 'Salvage Toggle Fire Disintegrate', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_gimbal_mode', label: 'Salvage Toggle Gimbal Mode', type: 'button', tier: 'extended' },
      { name: 'v_salvage_reset_gimbal', label: 'Salvage Reset Gimbal', type: 'button', tier: 'extended' },
      { name: 'v_salvage_increase_beam_spacing', label: 'Salvage Increase Beam Spacing', type: 'button', tier: 'extended' },
      { name: 'v_salvage_decrease_beam_spacing', label: 'Salvage Decrease Beam Spacing', type: 'button', tier: 'extended' },
      { name: 'v_salvage_beam_spacing_rel', label: 'Salvage Beam Spacing Rel', type: 'button', tier: 'extended' },
      { name: 'v_salvage_beam_spacing_abs', label: 'Salvage Beam Spacing Abs', type: 'button', tier: 'extended' },
      { name: 'v_salvage_toggle_beam_spacing_axis', label: 'Salvage Toggle Beam Spacing Axis', type: 'button', tier: 'extended' },
      { name: 'v_salvage_cycle_modifiers_focused', label: 'Salvage Cycle Modifiers Focused', type: 'button', tier: 'extended' },
      { name: 'v_salvage_cycle_modifiers_left', label: 'Salvage Cycle Modifiers Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_cycle_modifiers_right', label: 'Salvage Cycle Modifiers Right', type: 'button', tier: 'extended' },
      { name: 'v_salvage_cycle_modifiers_structural', label: 'Salvage Cycle Modifiers Structural', type: 'button', tier: 'extended' },
      { name: 'v_salvage_focus_all_heads', label: 'Salvage Focus All Heads', type: 'button', tier: 'extended' },
      { name: 'v_salvage_focus_left', label: 'Salvage Focus Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_focus_right', label: 'Salvage Focus Right', type: 'button', tier: 'extended' },
      { name: 'v_salvage_focus_fracture', label: 'Salvage Focus Fracture', type: 'button', tier: 'extended' },
      { name: 'v_salvage_focus_disintegrate', label: 'Salvage Focus Disintegrate', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_up__left', label: 'Salvage Nudge Up  Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_down__left', label: 'Salvage Nudge Down  Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_left__left', label: 'Salvage Nudge Left  Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_right__left', label: 'Salvage Nudge Right  Left', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_up__right', label: 'Salvage Nudge Up  Right', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_down__right', label: 'Salvage Nudge Down  Right', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_left__right', label: 'Salvage Nudge Left  Right', type: 'button', tier: 'extended' },
      { name: 'v_salvage_nudge_right__right', label: 'Salvage Nudge Right  Right', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_hud: {
    label: 'HUD & Comms',
    actions: [
      { name: 'v_cycle_pitch_ladder_mode', label: 'Cycle Pitch Ladder Mode', type: 'button', tier: 'advanced' },
      { name: 'mobiglas', label: 'MobiGlas', type: 'button', tier: 'advanced' },
      { name: 'toggle_ar_mode', label: 'Toggle Ar Mode', type: 'button', tier: 'advanced' },
      { name: 'v_hud_open_scoreboard', label: 'Hud Open Scoreboard', type: 'button', tier: 'advanced' },
      { name: 'v_hud_interact_toggle', label: 'Hud Interact Toggle', type: 'button', tier: 'advanced' },
      { name: 'v_hud_cycle_mode_fwd', label: 'Hud Cycle Mode Fwd', type: 'button', tier: 'advanced' },
      { name: 'v_hud_cycle_mode_back', label: 'Hud Cycle Mode Back', type: 'button', tier: 'advanced' },
      { name: 'v_hud_focused_cycle_mode_fwd', label: 'Hud Focused Cycle Mode Fwd', type: 'button', tier: 'advanced' },
      { name: 'v_hud_focused_cycle_mode_back', label: 'Hud Focused Cycle Mode Back', type: 'button', tier: 'advanced' },
      { name: 'v_hud_left_panel_up', label: 'Hud Left Panel Up', type: 'button', tier: 'advanced' },
      { name: 'v_hud_left_panel_down', label: 'Hud Left Panel Down', type: 'button', tier: 'advanced' },
      { name: 'v_hud_left_panel_left', label: 'Hud Left Panel Left', type: 'button', tier: 'advanced' },
      { name: 'v_hud_left_panel_right', label: 'Hud Left Panel Right', type: 'button', tier: 'advanced' },
      { name: 'v_hud_confirm', label: 'Hud Confirm', type: 'button', tier: 'advanced' },
      { name: 'v_hud_cancel', label: 'Hud Cancel', type: 'button', tier: 'advanced' },
      { name: 'v_hud_stick_x', label: 'Hud Stick X', type: 'button', tier: 'advanced' },
      { name: 'v_hud_stick_y', label: 'Hud Stick Y', type: 'button', tier: 'advanced' },
      { name: 'v_comm_open_chat', label: 'Comm Open Chat', type: 'button', tier: 'advanced' },
      { name: 'v_comm_show_chat', label: 'Comm Show Chat', type: 'button', tier: 'advanced' },
      { name: 'v_comm_open_precanned', label: 'Comm Open Precanned', type: 'button', tier: 'advanced' },
      { name: 'v_comm_select_precanned_1', label: 'Comm Select Precanned 1', type: 'button', tier: 'advanced' },
      { name: 'v_comm_select_precanned_2', label: 'Comm Select Precanned 2', type: 'button', tier: 'advanced' },
      { name: 'v_comm_select_precanned_3', label: 'Comm Select Precanned 3', type: 'button', tier: 'advanced' },
      { name: 'v_comm_select_precanned_4', label: 'Comm Select Precanned 4', type: 'button', tier: 'advanced' },
      { name: 'v_comm_select_precanned_5', label: 'Comm Select Precanned 5', type: 'button', tier: 'advanced' },
      { name: 'v_starmap', label: 'Star Map', type: 'button', tier: 'advanced' },
      { name: 'visor_wipe', label: 'Visor Wipe', type: 'button', tier: 'advanced' },
    ]
  },
  spaceship_auto_weapons: {
    label: 'Auto Weapons',
    actions: [
      { name: 'v_weapon_toggle_ai', label: 'Toggle AI Weapons', type: 'button', tier: 'extended' },
    ]
  },
  spaceship_target_hailing: {
    label: 'Hailing',
    actions: [
      { name: 'v_target_hail', label: 'Hail Target', type: 'button', tier: 'extended' },
    ]
  },
  turret_movement: {
    label: 'Turret Movement',
    actions: [
      { name: 'turret_pitch_up', label: 'Pitch Up', type: 'button', tier: 'extended' },
      { name: 'turret_pitch_down', label: 'Pitch Down', type: 'button', tier: 'extended' },
      { name: 'turret_pitch', label: 'Turret Pitch', type: 'axis', tier: 'extended', optionGroup: 'turret_aim_pitch' },
      { name: 'turret_yaw_left', label: 'Yaw Left', type: 'button', tier: 'extended' },
      { name: 'turret_yaw_right', label: 'Yaw Right', type: 'button', tier: 'extended' },
      { name: 'turret_yaw', label: 'Turret Yaw', type: 'axis', tier: 'extended', optionGroup: 'turret_aim_yaw' },
      { name: 'turret_toggle_mouse_mode', label: 'Toggle Mouse Mode', type: 'button', tier: 'extended' },
      { name: 'turret_mouse_mode_cycle', label: 'Mouse Mode Cycle', type: 'button', tier: 'extended' },
      { name: 'turret_mouse_mode_set_vjoy', label: 'Mouse Mode Set Vjoy', type: 'button', tier: 'extended' },
      { name: 'turret_mouse_mode_set_1to1', label: 'Mouse Mode Set 1To1', type: 'button', tier: 'extended' },
      { name: 'turret_mouse_mode_set_pointer', label: 'Mouse Mode Set Pointer', type: 'button', tier: 'extended' },
      { name: 'turret_remote_exit', label: 'Remote Exit', type: 'button', tier: 'extended' },
      { name: 'turret_gyromode', label: 'Turret Gyro Mode', type: 'button', tier: 'extended' },
      { name: 'turret_remote_cycle_next', label: 'Remote Cycle Next', type: 'button', tier: 'extended' },
      { name: 'turret_remote_cycle_prev', label: 'Remote Cycle Prev', type: 'button', tier: 'extended' },
    ]
  },
  turret_advanced: {
    label: 'Turret Advanced',
    actions: [
      { name: 'turret_esp_toggle', label: 'Esp Toggle', type: 'button', tier: 'extended' },
      { name: 'turret_esp_hold', label: 'Esp Hold', type: 'button', tier: 'advanced' },
      { name: 'turret_recenter', label: 'Recenter', type: 'button', tier: 'extended' },
      { name: 'turret_limiter_toggle', label: 'Limiter Toggle', type: 'button', tier: 'extended' },
      { name: 'turret_limiter_rel', label: 'Limiter Rel', type: 'axis', tier: 'extended', optionGroup: 'turret_limiter_relative' },
      { name: 'turret_limiter_rel_increase', label: 'Limiter Rel Increase', type: 'button', tier: 'extended' },
      { name: 'turret_limiter_rel_decrease', label: 'Limiter Rel Decrease', type: 'button', tier: 'extended' },
      { name: 'turret_limiter_abs', label: 'Limiter Abs', type: 'axis', tier: 'extended', optionGroup: 'turret_limiter_absolute' },
      { name: 'turret_change_position', label: 'Change Position', type: 'button', tier: 'extended' },
    ]
  },
  zero_gravity_eva: {
    label: 'EVA',
    actions: [
      { name: 'eva_view_yaw_left', label: 'View Yaw Left', type: 'button', tier: 'advanced' },
      { name: 'eva_view_yaw_right', label: 'View Yaw Right', type: 'button', tier: 'advanced' },
      { name: 'eva_view_yaw', label: 'View Yaw', type: 'axis', tier: 'advanced', optionGroup: 'fps_view_yaw' },
      { name: 'eva_view_pitch_up', label: 'View Pitch Up', type: 'button', tier: 'advanced' },
      { name: 'eva_view_pitch_down', label: 'View Pitch Down', type: 'button', tier: 'advanced' },
      { name: 'eva_view_pitch', label: 'View Pitch', type: 'axis', tier: 'advanced', optionGroup: 'fps_view_pitch' },
      { name: 'eva_roll_left', label: 'Roll Left', type: 'button', tier: 'advanced' },
      { name: 'eva_roll_right', label: 'Roll Right', type: 'button', tier: 'advanced' },
      { name: 'eva_roll', label: 'Roll', type: 'axis', tier: 'advanced', optionGroup: 'fps_view_roll' },
      { name: 'eva_strafe_up', label: 'Strafe Up', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_vertical' },
      { name: 'eva_strafe_down', label: 'Strafe Down', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_vertical' },
      { name: 'eva_strafe_vertical', label: 'Strafe Vertical', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_vertical' },
      { name: 'eva_strafe_left', label: 'Strafe Left', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_lateral' },
      { name: 'eva_strafe_right', label: 'Strafe Right', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_lateral' },
      { name: 'eva_strafe_lateral', label: 'Strafe Lateral', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_lateral' },
      { name: 'eva_strafe_forward', label: 'Strafe Forward', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_longitudinal' },
      { name: 'eva_strafe_back', label: 'Strafe Back', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_longitudinal' },
      { name: 'eva_strafe_longitudinal', label: 'Strafe Longitudinal', type: 'axis', tier: 'advanced', optionGroup: 'eva_move_strafe_longitudinal' },
      { name: 'eva_brake', label: 'Brake', type: 'button', tier: 'advanced' },
      { name: 'eva_boost', label: 'Boost', type: 'button', tier: 'advanced' },
      { name: 'eva_toggle_headlook_mode', label: 'Toggle Headlook Mode', type: 'button', tier: 'advanced' },
    ]
  },
  vehicle_driver: {
    label: 'Ground Vehicle',
    actions: [
      { name: 'v_move_forward', label: 'Move Forward', type: 'axis', tier: 'advanced', optionGroup: 'mgv_move_forward' },
      { name: 'v_move_back', label: 'Move Back', type: 'axis', tier: 'advanced', optionGroup: 'mgv_move_backward' },
      { name: 'v_move', label: 'Move', type: 'axis', tier: 'advanced', optionGroup: 'mgv_move' },
      { name: 'v_yaw_left', label: 'Yaw Left', type: 'button', tier: 'advanced' },
      { name: 'v_yaw_right', label: 'Yaw Right', type: 'button', tier: 'advanced' },
      { name: 'v_yaw', label: 'Yaw', type: 'axis', tier: 'essential', optionGroup: 'mgv_move_yaw' },
      { name: 'v_pitch_up', label: 'Pitch Up', type: 'button', tier: 'advanced' },
      { name: 'v_pitch_down', label: 'Pitch Down', type: 'button', tier: 'advanced' },
      { name: 'v_pitch', label: 'Pitch', type: 'axis', tier: 'essential', optionGroup: 'mgv_move_pitch' },
      { name: 'v_brake', label: 'Brake', type: 'button', tier: 'advanced' },
      { name: 'v_view_dynamic_zoom_rel', label: 'View Dynamic Zoom Rel', type: 'axis', tier: 'advanced', optionGroup: 'mgv_zoom' },
      { name: 'v_view_dynamic_zoom_rel_in', label: 'View Dynamic Zoom Rel In', type: 'button', tier: 'advanced' },
      { name: 'v_view_dynamic_zoom_rel_out', label: 'View Dynamic Zoom Rel Out', type: 'button', tier: 'advanced' },
      { name: 'v_view_dynamic_zoom_abs', label: 'View Dynamic Zoom Abs', type: 'axis', tier: 'advanced', optionGroup: 'mgv_zoom_abs' },
      { name: 'v_view_dynamic_zoom_abs_toggle', label: 'View Dynamic Zoom Abs Toggle', type: 'button', tier: 'advanced' },
      { name: 'v_boost', label: 'Boost', type: 'button', tier: 'advanced' },
      { name: 'v_lock_rotation', label: 'Lock Rotation', type: 'button', tier: 'advanced' },
      { name: 'v_mgv_switch_brake_on_idle', label: 'Mgv Switch Brake On Idle', type: 'button', tier: 'advanced' },
    ]
  },
  tractor_beam: {
    label: 'Tractor Beam',
    actions: [
      { name: 'tractor_beam_increase_distance', label: 'Increase Distance', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_decrease_distance', label: 'Decrease Distance', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_rotate', label: 'Rotate', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_rotate_x', label: 'Rotate X', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_rotate_y', label: 'Rotate Y', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_rotate_z_up', label: 'Rotate Z Up', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_rotate_z_down', label: 'Rotate Z Down', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_detach', label: 'Detach', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_throw', label: 'Throw', type: 'button', tier: 'extended' },
      { name: 'tractor_beam_reset_rotation', label: 'Reset Rotation', type: 'button', tier: 'extended' },
    ]
  },
};

// ==============================================================
// ACTION LABEL LOOKUP (flat map for O(1) access)
// ==============================================================
const ACTION_LABEL_MAP = {};
for (const cat of Object.values(SC_ACTIONS)) {
  for (const a of cat.actions) ACTION_LABEL_MAP[a.name] = a.label;
}

// ==============================================================
// BINDING STATE
// ==============================================================
let bindings = {}; // { 'v_pitch': 'js1_y', ... }
let axisInversions = {}; // { 'v_strafe_longitudinal': true, ... }
let listeningAction = null; // action name currently waiting for input
let baselineAxes = { js1: null, js2: null }; // snapshot axes at listen start
let reverseBindings = {}; // { 'js1_y': 'Pitch', 'js2_z': 'Throttle (Fwd/Back)', ... }

function rebuildReverseBindings() {
  reverseBindings = {};
  for (const [action, input] of Object.entries(bindings)) {
    reverseBindings[input] = ACTION_LABEL_MAP[action] || action;
  }
}

// ==============================================================
// PERSISTENCE (localStorage)
// ==============================================================
const STORAGE_KEY = 'sc_hotas_bindings_v1';

function saveBindings() {
  try {
    const data = { bindings, axisInversions, profileName: document.getElementById('profile-name-input').value };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch(e) { /* quota exceeded or private mode */ }
}

function loadBindings() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);
    if (data.bindings) bindings = data.bindings;
    if (data.axisInversions) axisInversions = data.axisInversions;
    if (data.profileName) {
      const el = document.getElementById('profile-name-input');
      if (el) el.value = data.profileName;
    }
  } catch(e) { /* corrupted data */ }
}

function clearSavedData() {
  if (!confirm('Clear all saved data from browser? This will not affect your current bindings.')) return;
  localStorage.removeItem(STORAGE_KEY);
  showToast('Saved data cleared');
}

// ==============================================================
// GAMEPAD STATE (shared between modes)
// ==============================================================
let gamepads = {};
let js1Index = -1;
let js2Index = -1;
let prevButtonStates = { js1: {}, js2: {} };
let logEntries = [];
const MAX_LOG = 50;
let currentMode = 'test';
let lastDetectedInput = '';

// ==============================================================
// TEST MODE MAPS (unchanged from original)
// ==============================================================
// Button maps: 'action' is the default label shown when no binding exists.
// refreshButtonGrid() overwrites with actual bound action labels from reverseBindings.
function buildButtonMap(prefix, count) {
  const map = {};
  for (let i = 0; i < count; i++) {
    map[i] = { sc: `button${i+1}`, action: `button${i+1}`, detail: `${prefix}_button${i+1}` };
  }
  return map;
}
const JS1_BUTTON_MAP = buildButtonMap('js1', 16);
const JS2_BUTTON_MAP = buildButtonMap('js2', 14);
const JS1_HAT_ACTIONS = { up: 'hat1_up', right: 'hat1_right', down: 'hat1_down', left: 'hat1_left' };
const JS2_HAT_ACTIONS = { up: 'hat1_up', right: 'hat1_right', down: 'hat1_down', left: 'hat1_left' };

// ==============================================================
// MODE SWITCHING
// ==============================================================
function switchMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
  document.getElementById('test-mode').style.display = mode === 'test' ? 'block' : 'none';
  document.getElementById('bind-mode').style.display = mode === 'bind' ? 'block' : 'none';

  const anyGP = Object.keys(gamepads).length > 0;
  document.getElementById('no-gamepad').style.display = anyGP ? 'none' : 'block';
  if (mode === 'test' && anyGP) {
    document.getElementById('test-mode').style.display = 'block';
    refreshTestModeLabels();
  }
}

// ==============================================================
// GAMEPAD PLUMBING (shared)
// ==============================================================
window.addEventListener('gamepadconnected', (e) => {
  gamepads[e.gamepad.index] = e.gamepad;
  updateDeviceSelects();
  autoAssignDevices();
  updateConnectionStatus();
  showMainContent();
});
window.addEventListener('gamepaddisconnected', (e) => {
  delete gamepads[e.gamepad.index];
  updateDeviceSelects();
  autoAssignDevices();
  updateConnectionStatus();
});

function updateDeviceSelects() {
  const gps = navigator.getGamepads();
  for (const selId of ['js1-select', 'js2-select']) {
    const sel = document.getElementById(selId);
    if (!sel) continue;
    const currentVal = sel.value;
    sel.innerHTML = '<option value="-1">Auto-detect</option>';
    for (let i = 0; i < gps.length; i++) {
      if (gps[i]) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `[${i}] ${gps[i].id.substring(0, 50)}`;
        sel.appendChild(opt);
      }
    }
    sel.value = currentVal;
  }
}

const js1Sel = document.getElementById('js1-select');
const js2Sel = document.getElementById('js2-select');
if (js1Sel) js1Sel.addEventListener('change', (e) => { js1Index = parseInt(e.target.value); updateConnectionStatus(); });
if (js2Sel) js2Sel.addEventListener('change', (e) => { js2Index = parseInt(e.target.value); updateConnectionStatus(); });

function autoAssignDevices() {
  const gps = navigator.getGamepads();
  let ji = -1, ti = -1;
  // Use device database to identify devices by role
  for (let i = 0; i < gps.length; i++) {
    if (!gps[i]) continue;
    const profile = identifyDevice(gps[i]);
    if (profile.defaultRole === 'js1' && ji === -1) ji = i;
    else if (profile.defaultRole === 'js2' && ti === -1) ti = i;
  }
  // Fallback: assign first two unknown devices in order
  if (ji === -1 && ti === -1) {
    const idx = []; for (let i = 0; i < gps.length; i++) { if (gps[i]) idx.push(i); }
    if (idx.length >= 1) ji = idx[0]; if (idx.length >= 2) ti = idx[1];
  }
  if (js1Index === -1 && ji !== -1) document.getElementById('js1-select').value = ji;
  if (js2Index === -1 && ti !== -1) document.getElementById('js2-select').value = ti;
}

function getJS(which) {
  const gps = navigator.getGamepads();
  const idx = which === 1 ? js1Index : js2Index;
  if (idx >= 0) return gps[idx] || null;
  const role = which === 1 ? 'js1' : 'js2';
  // Try device database match first
  for (let i = 0; i < gps.length; i++) {
    if (!gps[i]) continue;
    const profile = identifyDevice(gps[i]);
    if (profile.defaultRole === role) return gps[i];
  }
  // Fallback: assign by order
  const js1 = which === 2 ? getJS(1) : null;
  let fallbackIdx = 0;
  for (let i = 0; i < gps.length; i++) {
    if (gps[i]) {
      if (which === 2 && gps[i] === js1) continue;
      if (which === 1 && fallbackIdx === 0) return gps[i];
      if (which === 2) return gps[i];
      fallbackIdx++;
    }
  }
  return null;
}
function getJS1() { return getJS(1); }
function getJS2() { return getJS(2); }

function updateConnectionStatus() {
  const js1 = getJS1(), js2 = getJS2();
  const d1 = document.getElementById('js1-status'), n1 = document.getElementById('js1-name');
  if (js1) { d1.classList.add('connected'); n1.textContent = `JS1: ${js1.id.substring(0,40)}`; }
  else { d1.classList.remove('connected'); n1.textContent = 'JS1 (Joystick): Not connected'; }
  const d2 = document.getElementById('js2-status'), n2 = document.getElementById('js2-name');
  if (js2) { d2.classList.add('connected'); n2.textContent = `JS2: ${js2.id.substring(0,40)}`; }
  else { d2.classList.remove('connected'); n2.textContent = 'JS2 (Throttle): Not connected'; }
}

function showMainContent() {
  document.getElementById('no-gamepad').style.display = 'none';
  if (currentMode === 'test') document.getElementById('test-mode').style.display = 'block';
}

// ==============================================================
// TEST MODE LOGIC (unchanged)
// ==============================================================
function initButtonGrid(cid, bmap) {
  const c = document.getElementById(cid); if(!c) return; c.innerHTML = '';
  for (const [i, info] of Object.entries(bmap)) {
    const d = document.createElement('div'); d.className = 'btn-item'; d.id = `${cid}-${i}`;
    d.innerHTML = `<div class="btn-indicator">${parseInt(i)+1}</div><span class="btn-action" title="${info.detail}">${info.action}</span>`;
    c.appendChild(d);
  }
}
initButtonGrid('js1-buttons', JS1_BUTTON_MAP);
initButtonGrid('js2-buttons', JS2_BUTTON_MAP);

// ==============================================================
// TEST MODE: Sync labels with Bind Mode bindings
// ==============================================================
function refreshButtonGrid(prefix, buttonMap) {
  for (const [i, info] of Object.entries(buttonMap)) {
    const el = document.getElementById(`${prefix}-buttons-${i}`);
    if (!el) continue;
    const inputKey = `${prefix}_button${parseInt(i)+1}`;
    const boundLabel = reverseBindings[inputKey];
    const actionSpan = el.querySelector('.btn-action');
    if (actionSpan) {
      actionSpan.textContent = boundLabel || info.action;
      actionSpan.title = boundLabel ? inputKey : info.detail;
    }
  }
}

function refreshAxisLabels() {
  const axisSpans = {
    'js1-act-x': 'js1_x',  'js1-act-y': 'js1_y',  'js1-act-z': 'js1_rotz',
    'js2-act-z': 'js2_z',  'js2-act-x': 'js2_x',  'js2-act-y': 'js2_y',  'js2-act-rx': 'js2_rotx'
  };
  for (const [spanId, inputKey] of Object.entries(axisSpans)) {
    const el = document.getElementById(spanId);
    if (el) el.textContent = reverseBindings[inputKey] || inputKey;
  }
}

function refreshHatLabels() {
  const hatConfigs = [
    ['js1', JS1_HAT_ACTIONS],
    ['js2', JS2_HAT_ACTIONS]
  ];
  for (const [prefix, defaultActions] of hatConfigs) {
    for (const dir of ['up', 'down', 'left', 'right']) {
      const labelEl = document.getElementById(`${prefix}-hat-label-${dir}`);
      if (!labelEl) continue;
      const nameSpan = labelEl.querySelector('.action-name');
      if (!nameSpan) continue;
      const inputKey = `${prefix}_hat1_${dir}`;
      nameSpan.textContent = reverseBindings[inputKey] || defaultActions[dir];
    }
  }
}

function refreshTestModeLabels() {
  refreshButtonGrid('js1', JS1_BUTTON_MAP);
  refreshButtonGrid('js2', JS2_BUTTON_MAP);
  refreshAxisLabels();
  refreshHatLabels();
}

function setDeadzone(id, dz) {
  const el = document.getElementById(id); if(!el) return;
  el.style.left = (50-dz*50)+'%'; el.style.width = (dz*100)+'%';
}
setDeadzone('js1-dz-x',0.05); setDeadzone('js1-dz-y',0.05); setDeadzone('js1-dz-z',0.10);
setDeadzone('js2-dz-x',0.15); setDeadzone('js2-dz-y',0.15); setDeadzone('js2-dz-z',0.02); setDeadzone('js2-dz-rx',0.10);

function updateAxisBar(barId, valId, value, isThrottle=false) {
  const bar = document.getElementById(barId), val = document.getElementById(valId);
  if (!bar||!val) return; val.textContent = value.toFixed(2);
  if (isThrottle) { const p=((value+1)/2)*100; bar.style.left='2px'; bar.style.width=`calc(${p}% - 4px)`; bar.className='axis-bar-fill throttle'; }
  else { const p=value*50; if(value>=0){bar.style.left='50%';bar.style.width=p+'%';bar.className='axis-bar-fill';}else{bar.style.left=(50+p)+'%';bar.style.width=(-p)+'%';bar.className='axis-bar-fill negative';} }
}

function getHatState(gp) {
  const n=gp.axes.length;
  if(n>=2){const hx=gp.axes[n-2],hy=gp.axes[n-1];const r={up:hy<-0.5,down:hy>0.5,left:hx<-0.5,right:hx>0.5,isAxes:true};if(r.up||r.down||r.left||r.right)return r;}
  const nb=gp.buttons.length;
  if(nb>4){const s=nb-4;const r={up:gp.buttons[s].pressed,right:gp.buttons[s+1].pressed,down:gp.buttons[s+2].pressed,left:gp.buttons[s+3].pressed};if(r.up||r.down||r.left||r.right)return r;}
  return {up:false,down:false,left:false,right:false};
}
function updateHat(pfx,hs) {
  for(const d of['up','down','left','right']){
    const e=document.getElementById(`${pfx}-hat-${d}`),l=document.getElementById(`${pfx}-hat-label-${d}`);
    if(e)e.classList.toggle('active',hs[d]); if(l)l.classList.toggle('active',hs[d]);
  }
}
function addLogEntry(dev,inp,act) {
  const t=new Date().toLocaleTimeString('en-US',{hour12:false});
  logEntries.unshift({time:t,device:dev,input:inp,action:act});
  if(logEntries.length>MAX_LOG)logEntries.pop();
  const el=document.getElementById('action-log'); if(!el) return;
  el.innerHTML=logEntries.map(e=>`<div class="log-entry"><span class="log-time">${e.time}</span> <span class="log-input">${e.device} ${e.input}</span> &rarr; <span class="log-action">${e.action}</span></div>`).join('');
}

// ==============================================================
// BIND MODE: Build UI
// ==============================================================
function buildBindUI() {
  const container = document.getElementById('bind-categories');
  container.innerHTML = '';
  for (const [mapName, cat] of Object.entries(SC_ACTIONS)) {
    const catDiv = document.createElement('div');
    catDiv.className = 'bind-category';
    catDiv.id = `bind-cat-${mapName}`;
    const header = document.createElement('div');
    header.className = 'bind-cat-header';
    header.innerHTML = `<span class="cat-name">${cat.label}</span><span class="cat-badge cat-count">${cat.actions.length}</span><span class="cat-arrow">&#9654;</span>`;
    header.onclick = () => {
      header.classList.toggle('open');
      body.classList.toggle('open');
    };
    const body = document.createElement('div');
    body.className = 'bind-cat-body';
    for (const action of cat.actions) {
      const row = document.createElement('div');
      row.className = 'bind-action-row';
      row.id = `bind-row-${action.name}`;
      const current = bindings[action.name] || '';
      row.innerHTML = `
        <div class="action-name-col">
          <div class="action-label">${action.label}</div>
          <div class="action-sc-name">${action.name}</div>
        </div>
        <div class="binding-col">
          <span class="binding-value ${current ? '' : 'empty'}" id="bind-val-${action.name}" title="${current}">${current ? parseInputDisplayName(current) : '---'}</span>
        </div>
        <div class="action-buttons">
          ${action.type === 'axis' ? `<label class="invert-label" title="Invert this axis"><input type="checkbox" onchange="toggleInvert('${action.name}', this.checked)" ${axisInversions[action.name] ? 'checked' : ''}> Inv</label>` : ''}
          <button class="bind-btn" onclick="startListening('${action.name}')">Bind</button>
          <button class="clear-btn" onclick="clearBinding('${action.name}')">&#10005;</button>
        </div>`;
      body.appendChild(row);
    }
    catDiv.appendChild(header);
    catDiv.appendChild(body);
    container.appendChild(catDiv);
  }
}
loadBindings();
buildBindUI();

// ==============================================================
// BIND MODE: Search & Filter
// ==============================================================
function filterBindUI() {
  const query = (document.getElementById('bind-search').value || '').toLowerCase();
  const typeFilter = document.getElementById('bind-filter-type').value;
  const statusFilter = document.getElementById('bind-filter-status').value;
  const tierFilter = document.getElementById('bind-filter-tier').value;

  // Tier hierarchy: essential < extended < advanced (show all up to selected tier)
  const tierLevels = { essential: 1, extended: 2, advanced: 3 };
  const maxTier = tierLevels[tierFilter] || 3;

  // Build conflict set for "conflict" filter
  const inputCounts = {};
  for (const inp of Object.values(bindings)) { inputCounts[inp] = (inputCounts[inp]||0) + 1; }

  for (const [mapName, cat] of Object.entries(SC_ACTIONS)) {
    const catDiv = document.getElementById(`bind-cat-${mapName}`);
    if (!catDiv) continue;
    let visibleCount = 0;
    for (const action of cat.actions) {
      const row = document.getElementById(`bind-row-${action.name}`);
      if (!row) continue;
      const actionTier = tierLevels[action.tier || 'extended'] || 2;
      const matchesTier = actionTier <= maxTier;
      const matchesSearch = !query || action.label.toLowerCase().includes(query) || action.name.toLowerCase().includes(query);
      const matchesType = typeFilter === 'all' || action.type === typeFilter;
      const isBound = !!bindings[action.name];
      const isConflict = isBound && inputCounts[bindings[action.name]] > 1;
      const matchesStatus = statusFilter === 'all'
        || (statusFilter === 'bound' && isBound)
        || (statusFilter === 'unbound' && !isBound)
        || (statusFilter === 'conflict' && isConflict);
      const visible = matchesTier && matchesSearch && matchesType && matchesStatus;
      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    }
    catDiv.style.display = visibleCount > 0 ? '' : 'none';
    // Update category badge count when filtering
    const badge = catDiv.querySelector('.cat-badge');
    if (badge) badge.textContent = visibleCount;
  }
}

document.getElementById('bind-search').addEventListener('input', filterBindUI);
document.getElementById('bind-filter-type').addEventListener('change', filterBindUI);
document.getElementById('bind-filter-status').addEventListener('change', filterBindUI);
document.getElementById('bind-filter-tier').addEventListener('change', filterBindUI);
filterBindUI(); // Apply initial tier filter
rebuildReverseBindings(); // Sync Test Mode with loaded bindings
refreshTestModeLabels();

// ==============================================================
// BIND MODE: Mini monitor
// ==============================================================
function buildMiniMonitor() {
  for (const jsNum of [1, 2]) {
    const axesEl = document.getElementById(`bind-mini-js${jsNum}-axes`);
    const btnsEl = document.getElementById(`bind-mini-js${jsNum}-btns`);
    axesEl.innerHTML = '';
    btnsEl.innerHTML = '';
    const labels = jsNum === 1 ? ['X','Y','Z'] : ['X','Y','Z','RX'];
    for (let i = 0; i < labels.length; i++) {
      axesEl.innerHTML += `<div class="mini-axis-row"><span class="mini-label">${labels[i]}</span><div class="mini-bar"><div class="mini-bar-fill" id="mini-js${jsNum}-a${i}" style="left:50%;width:0"></div></div><span class="mini-val" id="mini-js${jsNum}-av${i}">0.00</span></div>`;
    }
    const btnCount = jsNum === 1 ? 16 : 14;
    for (let i = 0; i < btnCount; i++) {
      btnsEl.innerHTML += `<div class="mini-btn" id="mini-js${jsNum}-b${i}">${i+1}</div>`;
    }
  }
}
buildMiniMonitor();

// ==============================================================
// BIND MODE: Input capture
// ==============================================================
function startListening(actionName) {
  // Cancel previous
  if (listeningAction) stopListening();
  listeningAction = actionName;
  // Snapshot current axes as baseline
  const js1 = getJS1(), js2 = getJS2();
  baselineAxes.js1 = js1 ? [...js1.axes] : null;
  baselineAxes.js2 = js2 ? [...js2.axes] : null;
  // UI feedback
  document.querySelectorAll('.bind-action-row.listening').forEach(r => r.classList.remove('listening'));
  const row = document.getElementById(`bind-row-${actionName}`);
  if (row) row.classList.add('listening');
  const valEl = document.getElementById(`bind-val-${actionName}`);
  if (valEl) { valEl.textContent = 'Press input...'; valEl.className = 'binding-value listening-indicator'; }
}

function stopListening() {
  if (!listeningAction) return;
  const row = document.getElementById(`bind-row-${listeningAction}`);
  if (row) row.classList.remove('listening');
  const valEl = document.getElementById(`bind-val-${listeningAction}`);
  if (valEl && valEl.classList.contains('listening-indicator')) {
    const cur = bindings[listeningAction] || '';
    valEl.textContent = cur ? parseInputDisplayName(cur) : '---';
    valEl.title = cur;
    valEl.className = 'binding-value' + (cur ? '' : ' empty');
  }
  listeningAction = null;
}

function captureInput(scInput) {
  if (!listeningAction) return;
  bindings[listeningAction] = scInput;
  const valEl = document.getElementById(`bind-val-${listeningAction}`);
  if (valEl) { valEl.textContent = parseInputDisplayName(scInput); valEl.title = scInput; valEl.className = 'binding-value'; }
  const row = document.getElementById(`bind-row-${listeningAction}`);
  if (row) row.classList.remove('listening');
  listeningAction = null;
  updateStats();
  rebuildReverseBindings();
  refreshTestModeLabels();
  saveBindings();
}

function clearBinding(actionName) {
  delete bindings[actionName];
  const valEl = document.getElementById(`bind-val-${actionName}`);
  if (valEl) { valEl.textContent = '---'; valEl.className = 'binding-value empty'; }
  updateStats();
  rebuildReverseBindings();
  refreshTestModeLabels();
  saveBindings();
}

function toggleInvert(actionName, checked) {
  if (checked) axisInversions[actionName] = true;
  else delete axisInversions[actionName];
  saveBindings();
}

function clearAllBindings() {
  if (!confirm('Clear all bindings?')) return;
  bindings = {};
  axisInversions = {};
  buildBindUI();
  filterBindUI();
  updateStats();
  rebuildReverseBindings();
  refreshTestModeLabels();
  saveBindings();
}

function updateStats() {
  let bound = 0, total = 0;
  for (const cat of Object.values(SC_ACTIONS)) { total += cat.actions.length; for (const a of cat.actions) { if (bindings[a.name]) bound++; } }
  document.getElementById('stats-bound').textContent = bound;
  document.getElementById('stats-unbound').textContent = total - bound;
  // Conflict detection
  const inputCounts = {};
  for (const inp of Object.values(bindings)) { inputCounts[inp] = (inputCounts[inp]||0) + 1; }
  const conflicts = Object.values(inputCounts).filter(c => c > 1).reduce((s,c) => s + c, 0);
  document.getElementById('stats-conflicts').textContent = conflicts;
  // Highlight conflicting rows
  for (const cat of Object.values(SC_ACTIONS)) {
    for (const a of cat.actions) {
      const row = document.getElementById(`bind-row-${a.name}`);
      if (!row) continue;
      const inp = bindings[a.name];
      row.classList.toggle('conflict', !!(inp && inputCounts[inp] > 1));
    }
  }
}
updateStats();

// ==============================================================
// FRIENDLY INPUT DISPLAY NAMES
// ==============================================================
function parseInputDisplayName(input) {
  if (!input) return '---';
  const m = input.match(/^(js\d+)_(.+)$/);
  if (!m) return input;
  const dev = m[1].toUpperCase(), rest = m[2];
  const hatMatch = rest.match(/^hat(\d+)_(up|down|left|right)$/);
  if (hatMatch) return `${dev} Hat ${hatMatch[2][0].toUpperCase() + hatMatch[2].slice(1)}`;
  const btnMatch = rest.match(/^button(\d+)$/);
  if (btnMatch) return `${dev} Btn ${btnMatch[1]}`;
  const axisNames = { x:'X', y:'Y', z:'Z', rotx:'RotX', roty:'RotY', rotz:'RotZ', slider1:'Slider1', slider2:'Slider2' };
  if (axisNames[rest]) return `${dev} ${axisNames[rest]} Axis`;
  return `${dev} ${rest}`;
}

// ==============================================================
// BIND MODE: Detect input in update loop
// ==============================================================
function getAxisName(jsNum, axisIdx) {
  // Tier 1: User override (future — stored in localStorage per device)
  // Tier 2: Device profile from DEVICE_DB
  const gp = jsNum === 1 ? getJS1() : getJS2();
  const profile = identifyDevice(gp);
  if (profile.scAxisFormat && profile.scAxisFormat[axisIdx] !== undefined) {
    return profile.scAxisFormat[axisIdx];
  }
  // Tier 3: Generic fallback
  const defaultMap = { 0: 'x', 1: 'y', 2: 'z', 3: 'rotx', 4: 'roty', 5: 'rotz', 6: 'slider1', 7: 'slider2' };
  return defaultMap[axisIdx] || `axis${axisIdx}`;
}

function detectInputForBinding() {
  const AXIS_THRESHOLD = 0.5;
  const AXIS_DELTA = 0.3; // how much it must move from baseline
  for (const jsNum of [1, 2]) {
    const gp = jsNum === 1 ? getJS1() : getJS2();
    if (!gp) continue;
    const prefix = `js${jsNum}`;

    // Buttons
    for (let i = 0; i < gp.buttons.length; i++) {
      if (gp.buttons[i].pressed) {
        captureInput(`${prefix}_button${i+1}`);
        return;
      }
    }

    // Hat (axes-based)
    const n = gp.axes.length;
    if (n >= 2) {
      const hx = gp.axes[n-2], hy = gp.axes[n-1];
      const bla = jsNum === 1 ? baselineAxes.js1 : baselineAxes.js2;
      const blhx = bla ? bla[n-2] : 0, blhy = bla ? bla[n-1] : 0;
      if (hy < -0.5 && Math.abs(hy - blhy) > AXIS_DELTA) { captureInput(`${prefix}_hat1_up`); return; }
      if (hy > 0.5 && Math.abs(hy - blhy) > AXIS_DELTA) { captureInput(`${prefix}_hat1_down`); return; }
      if (hx < -0.5 && Math.abs(hx - blhx) > AXIS_DELTA) { captureInput(`${prefix}_hat1_left`); return; }
      if (hx > 0.5 && Math.abs(hx - blhx) > AXIS_DELTA) { captureInput(`${prefix}_hat1_right`); return; }
    }

    // Regular axes
    const bl = jsNum === 1 ? baselineAxes.js1 : baselineAxes.js2;
    const axisLimit = n >= 4 ? n - 2 : n; // exclude hat axes
    for (let i = 0; i < axisLimit; i++) {
      const val = gp.axes[i];
      const base = bl ? bl[i] : 0;
      if (Math.abs(val) > AXIS_THRESHOLD && Math.abs(val - base) > AXIS_DELTA) {
        const axName = getAxisName(jsNum, i);
        captureInput(`${prefix}_${axName}`);
        return;
      }
    }
  }
}

// ==============================================================
// BIND MODE: Update mini monitor
// ==============================================================
function updateMiniMonitor() {
  let currentInput = '';
  for (const jsNum of [1, 2]) {
    const gp = jsNum === 1 ? getJS1() : getJS2();
    if (!gp) continue;
    // Axes
    const axisLabels = jsNum === 1 ? 3 : 4;
    for (let i = 0; i < axisLabels && i < gp.axes.length; i++) {
      const val = gp.axes[i];
      const bar = document.getElementById(`mini-js${jsNum}-a${i}`);
      const vEl = document.getElementById(`mini-js${jsNum}-av${i}`);
      if (bar) {
        const pct = val * 50;
        if (val >= 0) { bar.style.left = '50%'; bar.style.width = pct + '%'; }
        else { bar.style.left = (50+pct)+'%'; bar.style.width = (-pct)+'%'; }
      }
      if (vEl) vEl.textContent = val.toFixed(2);
      if (Math.abs(val) > 0.3) {
        const axName = getAxisName(jsNum, i);
        const rawInput = `js${jsNum}_${axName}`;
        currentInput = `${parseInputDisplayName(rawInput)} (${val.toFixed(2)})`;
      }
    }
    // Buttons
    const btnCount = jsNum === 1 ? 16 : 14;
    for (let i = 0; i < btnCount && i < gp.buttons.length; i++) {
      const el = document.getElementById(`mini-js${jsNum}-b${i}`);
      if (el) {
        const pressed = gp.buttons[i].pressed;
        el.classList.toggle('active', pressed);
        if (pressed) currentInput = parseInputDisplayName(`js${jsNum}_button${i+1}`);
      }
    }
    // Hat
    const hs = getHatState(gp);
    for (const d of ['up','down','left','right']) {
      if (hs[d]) currentInput = parseInputDisplayName(`js${jsNum}_hat1_${d}`);
    }
  }
  const display = document.getElementById('live-input-display');
  if (display) {
    if (currentInput) {
      display.textContent = currentInput;
      display.classList.add('has-input');
    } else {
      display.textContent = listeningAction ? 'Waiting for input...' : 'Move axis or press button';
      display.classList.remove('has-input');
    }
  }
  lastDetectedInput = currentInput;
}

// ==============================================================
// XML EXPORT
// ==============================================================
function generateXML() {
  const name = document.getElementById('profile-name-input').value || 'Custom_HOTAS';
  // Group bindings by actionmap
  const maps = {};
  for (const [mapName, cat] of Object.entries(SC_ACTIONS)) {
    const actionBindings = [];
    for (const a of cat.actions) {
      actionBindings.push({ name: a.name, input: bindings[a.name] || '' });
    }
    if (actionBindings.some(b => b.input)) maps[mapName] = actionBindings;
  }
  let xml = `<!-- Star Citizen HOTAS Profile -->\n`;
  xml += `<!-- Generated by SC HOTAS Tool -->\n`;
  xml += `<!-- Place in: USER/Client/0/Controls/Mappings -->\n`;
  xml += `<!-- Console: pp_RebindKeys ${name} -->\n`;
  xml += `<ActionMaps version="1" optionsVersion="2" rebindVersion="2" profileName="${esc(name)}">\n`;
  xml += ` <CustomisationUIHeader label="${esc(name)}" description="Generated by SC HOTAS Tool" image="">\n`;
  xml += `  <devices>\n   <keyboard instance="1"/>\n   <mouse instance="1"/>\n   <joystick instance="1"/>\n   <joystick instance="2"/>\n  </devices>\n`;
  xml += `  <categories>\n   <category label="@ui_CCSpaceFlight"/>\n  </categories>\n`;
  xml += ` </CustomisationUIHeader>\n\n`;
  xml += ` <options type="keyboard" instance="1"/>\n`;
  // Generate joystick options with inversions using optionGroup from AllBinds.xml
  const js1Inverts = [], js2Inverts = [];
  for (const [actionName, inverted] of Object.entries(axisInversions)) {
    if (!inverted) continue;
    const input = bindings[actionName];
    if (!input) continue;
    const m = input.match(/^js(\d+)_(.+)$/);
    if (!m) continue;
    const jsNum = m[1];
    // Look up optionGroup from SC_ACTIONS for correct XML export
    let optGroup = actionName; // fallback to action name
    for (const cat of Object.values(SC_ACTIONS)) {
      const act = cat.actions.find(a => a.name === actionName);
      if (act && act.optionGroup) { optGroup = act.optionGroup; break; }
    }
    const entry = `  <${optGroup} invert="1"/>`;
    if (jsNum === '1') js1Inverts.push(entry);
    else if (jsNum === '2') js2Inverts.push(entry);
  }
  xml += ` <options type="joystick" instance="1">\n  <flight_move exponent="1.5"/>\n${js1Inverts.map(e => e + '\n').join('')} </options>\n`;
  xml += ` <options type="joystick" instance="2">\n${js2Inverts.map(e => e + '\n').join('')} </options>\n\n`;
  xml += ` <modifiers />\n\n`;
  for (const [mapName, actions] of Object.entries(maps)) {
    xml += ` <actionmap name="${mapName}">\n`;
    for (const a of actions) {
      xml += `  <action name="${a.name}">\n   <rebind input="${esc(a.input)}"/>\n  </action>\n`;
    }
    xml += ` </actionmap>\n\n`;
  }
  xml += `</ActionMaps>\n`;
  return xml;
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function exportXML() {
  const xml = generateXML();
  document.getElementById('export-preview').textContent = xml;
  document.getElementById('export-modal').classList.remove('hidden');
}

function closeExportModal() { document.getElementById('export-modal').classList.add('hidden'); }

function copyXMLToClipboard() {
  const xml = generateXML();
  navigator.clipboard.writeText(xml).then(() => showToast('Copied to clipboard!'));
}

function downloadXML() {
  const name = document.getElementById('profile-name-input').value || 'Custom_HOTAS';
  const xml = generateXML();
  const blob = new Blob([xml], { type: 'application/xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `layout_${name}_exported.xml`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('XML downloaded!');
  closeExportModal();
}

// ==============================================================
// XML IMPORT
// ==============================================================
document.getElementById('import-xml-input').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const parser = new DOMParser();
      const doc = parser.parseFromString(ev.target.result, 'text/xml');
      const root = doc.querySelector('ActionMaps');
      if (!root) { showToast('Invalid XML: no ActionMaps root'); return; }
      // Profile name
      const pName = root.getAttribute('profileName');
      if (pName) document.getElementById('profile-name-input').value = pName;
      // Parse inversions from <options> blocks
      // Build reverse map: optionGroup → action names
      const optGroupToActions = {};
      for (const cat of Object.values(SC_ACTIONS)) {
        for (const a of cat.actions) {
          if (a.optionGroup) {
            if (!optGroupToActions[a.optionGroup]) optGroupToActions[a.optionGroup] = [];
            optGroupToActions[a.optionGroup].push(a.name);
          }
        }
      }
      axisInversions = {};
      const optionsEls = doc.querySelectorAll('options[type="joystick"]');
      optionsEls.forEach(optEl => {
        for (const child of optEl.children) {
          if (child.getAttribute('invert') === '1') {
            const tag = child.tagName;
            // Try optionGroup reverse lookup first, then fall back to treating as action name
            const actionNames = optGroupToActions[tag] || [tag];
            actionNames.forEach(n => { axisInversions[n] = true; });
          }
        }
      });
      // Parse bindings
      bindings = {};
      const actionEls = doc.querySelectorAll('actionmap > action');
      actionEls.forEach(aEl => {
        const name = aEl.getAttribute('name');
        const rebind = aEl.querySelector('rebind');
        if (rebind) {
          const input = rebind.getAttribute('input');
          if (input) bindings[name] = input;
        }
      });
      // Rebuild UI with imported bindings and inversions
      buildBindUI();
      filterBindUI();
      updateStats();
      rebuildReverseBindings();
      refreshTestModeLabels();
      saveBindings();
      showToast(`Imported ${Object.keys(bindings).length} bindings from "${pName}"`);
    } catch (err) {
      showToast('Error parsing XML: ' + err.message);
    }
  };
  reader.readAsText(file);
  e.target.value = ''; // reset
});

// ==============================================================
// TOAST
// ==============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ==============================================================
// MAIN UPDATE LOOP
// ==============================================================
function update() {
  const js1 = getJS1(), js2 = getJS2();

  // -- Test mode updates --
  if (currentMode === 'test' && js1) {
    const a = js1.axes, x = a[0]||0, y = a[1]||0;
    let z = 0; if(a.length>2)z=a[2]; if(a.length>5&&Math.abs(a[5])>Math.abs(z))z=a[5];
    updateAxisBar('js1-bar-x','js1-val-x',x); updateAxisBar('js1-bar-y','js1-val-y',y); updateAxisBar('js1-bar-z','js1-val-z',z);
    const dot=document.getElementById('js1-dot-xy'); if(dot){dot.style.left=(50+x*48)+'%';dot.style.top=(50+y*48)+'%';}
    const th=0.05;
    const ax=document.getElementById('js1-act-x'),ay=document.getElementById('js1-act-y'),az=document.getElementById('js1-act-z');
    if(ax)ax.classList.toggle('active',Math.abs(x)>th); if(ay)ay.classList.toggle('active',Math.abs(y)>th); if(az)az.classList.toggle('active',Math.abs(z)>th);
    for(const[i,info]of Object.entries(JS1_BUTTON_MAP)){const bi=parseInt(i);const el=document.getElementById(`js1-buttons-${i}`);if(el&&js1.buttons[bi]){const p=js1.buttons[bi].pressed;el.classList.toggle('active',p);const pp=prevButtonStates.js1[bi]||false;if(p&&!pp)addLogEntry('JS1',info.sc,reverseBindings[`js1_button${bi+1}`]||info.action);prevButtonStates.js1[bi]=p;}}
    const hs=getHatState(js1);updateHat('js1',hs);for(const d of['up','down','left','right']){const pd=prevButtonStates.js1[`hat_${d}`]||false;if(hs[d]&&!pd)addLogEntry('JS1',`hat1_${d}`,reverseBindings[`js1_hat1_${d}`]||JS1_HAT_ACTIONS[d]);prevButtonStates.js1[`hat_${d}`]=hs[d];}
  }
  if (currentMode === 'test' && js2) {
    const a=js2.axes,mx=a[0]||0,my=a[1]||0,thr=a.length>2?a[2]:0;
    let rk=0;if(a.length>3)rk=a[3];if(a.length>4&&Math.abs(a[4])>Math.abs(rk))rk=a[4];if(a.length>5&&Math.abs(a[5])>Math.abs(rk))rk=a[5];
    updateAxisBar('js2-bar-z','js2-val-z',thr,true);updateAxisBar('js2-bar-x','js2-val-x',mx);updateAxisBar('js2-bar-y','js2-val-y',my);updateAxisBar('js2-bar-rx','js2-val-rx',rk);
    const dot2=document.getElementById('js2-dot-xy');if(dot2){dot2.style.left=(50+mx*48)+'%';dot2.style.top=(50+my*48)+'%';}
    const th=0.05;
    const tz=document.getElementById('js2-act-z'),tx=document.getElementById('js2-act-x'),ty=document.getElementById('js2-act-y'),trx=document.getElementById('js2-act-rx');
    if(tz)tz.classList.toggle('active',Math.abs(thr)>th);if(tx)tx.classList.toggle('active',Math.abs(mx)>th);if(ty)ty.classList.toggle('active',Math.abs(my)>th);if(trx)trx.classList.toggle('active',Math.abs(rk)>th);
    for(const[i,info]of Object.entries(JS2_BUTTON_MAP)){const bi=parseInt(i);const el=document.getElementById(`js2-buttons-${i}`);if(el&&js2.buttons[bi]){const p=js2.buttons[bi].pressed;el.classList.toggle('active',p);const pp=prevButtonStates.js2[bi]||false;if(p&&!pp)addLogEntry('JS2',info.sc,reverseBindings[`js2_button${bi+1}`]||info.action);prevButtonStates.js2[bi]=p;}}
    const hs=getHatState(js2);updateHat('js2',hs);for(const d of['up','down','left','right']){const pd=prevButtonStates.js2[`hat_${d}`]||false;if(hs[d]&&!pd)addLogEntry('JS2',`hat1_${d}`,reverseBindings[`js2_hat1_${d}`]||JS2_HAT_ACTIONS[d]);prevButtonStates.js2[`hat_${d}`]=hs[d];}
  }

  // -- Bind mode updates --
  if (currentMode === 'bind') {
    updateMiniMonitor();
    if (listeningAction) detectInputForBinding();
  }

  requestAnimationFrame(update);
}
requestAnimationFrame(update);

// Gamepad polling fallback
setInterval(()=>{const gps=navigator.getGamepads();for(let i=0;i<gps.length;i++){if(gps[i]&&!gamepads[i]){gamepads[i]=gps[i];updateDeviceSelects();autoAssignDevices();updateConnectionStatus();showMainContent();}}},1000);

// ESC to cancel binding
document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && listeningAction) stopListening(); });
</script>
</body>
</html>
